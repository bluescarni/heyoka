// Copyright 2020, 2021, 2022, 2023, 2024 Francesco Biscani (bluescarni@gmail.com), Dario Izzo (dario.izzo@gmail.com)
//
// This file is part of the heyoka library.
//
// This Source Code Form is subject to the terms of the Mozilla
// Public License v. 2.0. If a copy of the MPL was not distributed
// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

#include <stdexcept>
#include <utility>
#include <vector>

#include <boost/math/constants/constants.hpp>

#include <heyoka/config.hpp>
#include <heyoka/expression.hpp>
#include <heyoka/kw.hpp>
#include <heyoka/math/cos.hpp>
#include <heyoka/math/exp.hpp>
#include <heyoka/math/sin.hpp>
#include <heyoka/math/sum.hpp>
#include <heyoka/math/tanh.hpp>
#include <heyoka/model/ffnn.hpp>
#include <heyoka/model/nrlmsise00_tn.hpp>

HEYOKA_BEGIN_NAMESPACE

namespace model::detail
{

namespace
{

const double best_global_fit[12]
    = {4.1363310029108843e-07, 4.0000086372179092e-08, 2.0884869739603035e-13, 2.3135716566189760e-09,
       5.5489346370934431e-02, 3.8843141843337967e-02, 5.4930843422492867e-03, 2.0221186124045831e-02,
       1.6037537639329329e+01, 5.2566535061531994e+01, 8.8684196024896238e+01, 2.6651672474562414e+01};

const double flattened_nw[1804]
    = {-0.0743581280112267, 0.0769632011651993,  -0.6323961615562439, 0.0002571544901002,  0.1434042453765869,
       -0.0227583944797516, 0.0611031353473663,  0.1003129407763481,  -0.0767103880643845, 0.6378574371337891,
       0.0053279395215213,  0.0134515995159745,  -0.0950274690985680, -0.0018566681537777, -0.0014472764451057,
       -0.4914893507957458, 0.0930972546339035,  -0.0472123995423317, -0.0191865786910057, -0.2148973941802979,
       -0.2497100085020065, -0.4954087734222412, -0.1942940205335617, -0.4953806698322296, -0.4802934825420380,
       -0.0004155066562817, -0.0086648510769010, -0.0030759351793677, 0.0012877191184089,  -0.0301488302648067,
       0.0230644773691893,  0.0231021530926228,  -3.9611506462097168, -0.0138060385361314, -0.1016528233885765,
       0.0272871293127537,  -0.0220847185701132, 0.0176015160977840,  -0.0776051506400108, 0.3893697857856750,
       -0.0168842896819115, -0.0165586173534393, 2.2788858413696289,  -0.0284899175167084, -0.0059819817543030,
       0.0389048866927624,  -0.3986852169036865, 0.0093145947903395,  -0.0145480427891016, 0.2961830496788025,
       0.1159194111824036,  0.0637580081820488,  -2.4110202789306641, 0.0176026392728090,  0.1189383119344711,
       -0.0277152918279171, 0.2063956856727600,  0.0856449976563454,  -0.0502768680453300, 0.1963385492563248,
       0.5736067295074463,  0.0719011351466179,  -0.3340022563934326, -0.0674792602658272, 0.6015058159828186,
       0.0014994668308645,  -0.0001064359166776, -0.0179351791739464, -0.0072803366929293, 0.1506934016942978,
       -0.2678239941596985, 0.5642486214637756,  0.6883878111839294,  0.5501347780227661,  -0.2194490730762482,
       0.0025607030838728,  -0.0447344630956650, -0.0100291296839714, -0.0230646971613169, -0.0653020367026329,
       0.2818726599216461,  0.7158322930335999,  0.0232235454022884,  0.2541279196739197,  -0.7325959205627441,
       -0.0089857531711459, 0.0041038487106562,  0.0085576241835952,  -0.0033687043469399, -0.0142531953752041,
       -0.2236859351396561, -0.0123049253597856, -0.4516885280609131, 0.0055538737215102,  0.1398725509643555,
       -0.0069044115953147, 0.0584772564470768,  -0.0253492891788483, 0.0694061517715454,  -0.8215776085853577,
       0.2114009410142899,  -0.1143445521593094, 2.3093740940093994,  -0.2110737115144730, 0.1473252177238464,
       0.0151687730103731,  -0.1289633363485336, -0.0586731806397438, 0.0112569713965058,  -0.1325988471508026,
       0.1974338144063950,  -0.1172592490911484, -0.9095443487167358, 0.2109674811363220,  -0.0252428855746984,
       0.0032372698187828,  -0.0798273012042046, -0.0427418164908886, -0.0445048436522484, 0.1066233590245247,
       -0.0196567941457033, 0.0232560504227877,  1.0917354822158813,  -0.0091825313866138, -0.0052060103043914,
       -0.0596557296812534, 0.4408826529979706,  -0.0088314600288868, 0.0211396552622318,  0.1020348146557808,
       0.0828378498554230,  -0.0370065011084080, -0.6421504616737366, 0.0075908959843218,  0.0170017722994089,
       -0.0007432762649842, -0.0630277842283249, -0.1693772673606873, 0.5398395657539368,  -0.1832370758056641,
       0.0102327382192016,  -0.0233604833483696, -0.5761114954948425, 0.0037037781439722,  0.0058629335835576,
       0.0057391277514398,  -0.2810205519199371, -0.1224374696612358, -0.0806622803211212, 0.1181997880339622,
       -0.0156706124544144, 0.0096608884632587,  0.1926816105842590,  -0.0010171011090279, 0.0094192419201136,
       0.3556988239288330,  -0.3643292188644409, 0.0403542220592499,  -0.0316259004175663, -0.1304634064435959,
       -0.1072967797517776, -0.5458009839057922, 0.5662155747413635,  0.0794661790132523,  0.5328799486160278,
       -0.0101668741554022, 0.0083205346018076,  0.0070033408701420,  0.0189161617308855,  -0.1058772578835487,
       -0.0381430424749851, -0.0076127042993903, 0.7840685248374939,  -0.0068680713884532, 0.0062646972946823,
       0.0031678560189903,  -0.2825649678707123, -0.0786247551441193, -0.0537406057119370, 0.2907239794731140,
       -0.0433271676301956, 0.0406009852886200,  0.6755115985870361,  -0.0072853863239288, -0.0015480902511626,
       -0.0566915906965733, -0.4448298215866089, -0.0068911015987396, 0.0482185594737530,  -0.1390087157487869,
       -0.2890965640544891, 0.1479538530111313,  0.2585066854953766,  0.1184726059436798,  -0.2528704702854156,
       -0.0114955892786384, 0.0626800358295441,  -0.0005240780883469, 0.0405637547373772,  0.2630434632301331,
       -0.8597177267074585, -0.5034504532814026, -0.4679865837097168, -0.8545721173286438, -0.1567526757717133,
       -0.0078394003212452, 0.0377581119537354,  0.1197045817971230,  -0.1296614259481430, 0.4905038475990295,
       -0.0244761444628239, 0.0301956702023745,  -0.2131742537021637, -0.0132634937763214, -0.0131172304973006,
       0.0637545362114906,  -0.1077595055103302, 0.4440456628799438,  -0.0184005256742239, 0.0194186698645353,
       0.1419755220413208,  -0.1087371334433556, -1.4349219799041748, -0.0144914109259844, -0.0535706765949726,
       0.0254199448972940,  -0.1062512546777725, 0.0709741935133934,  0.1047123447060585,  0.0036620839964598,
       0.3091763556003571,  -0.1867308616638184, 0.3821198046207428,  -0.2985430657863617, 0.2760466039180756,
       0.0024299630895257,  -0.0164491720497608, 0.0257510710507631,  0.0063288891687989,  0.0192130543291569,
       0.0176577847450972,  0.0028900213073939,  -0.3693090677261353, 0.0026008756831288,  -0.0013069380074739,
       0.6120643615722656,  -0.1664725989103317, -0.0238849148154259, -0.0438650250434875, -0.2077457159757614,
       -0.0071113714948297, 0.5629626512527466,  1.0999116897583008,  -0.1182794049382210, -0.4461820423603058,
       -0.0015017216792330, 0.0230013467371464,  0.0380957536399364,  0.0302479285746813,  -0.1518082022666931,
       0.0608598403632641,  -0.0334430113434792, -0.1076527610421181, -0.0322786457836628, 0.0034411600790918,
       -0.0108220744878054, -0.0087835490703583, 0.0818357691168785,  -0.1391290724277496, -0.7605900168418884,
       -0.3378253579139709, 0.5662633776664734,  -0.4445465803146362, -0.4251237511634827, -0.4039051532745361,
       0.0003473121905699,  -0.0202981922775507, 0.0772603377699852,  -0.0209745764732361, -0.0454284921288490,
       0.7591812014579773,  0.1311250627040863,  -0.2020532637834549, 0.6821807622909546,  -0.2573584914207458,
       0.0095082540065050,  0.0017925249412656,  -0.0114365983754396, -0.0145971132442355, 0.0497266165912151,
       0.5992529988288879,  -0.5267493128776550, -0.1466591656208038, 0.5593899488449097,  0.5221458673477173,
       0.0072814491577446,  -0.0105227688327432, 0.0370926000177860,  0.0013702691067010,  -0.0446585714817047,
       -0.5549376606941223, 0.0301562082022429,  -0.8344363570213318, -0.5608189105987549, 0.0981564447283745,
       0.0171664357185364,  -0.0187467597424984, -0.0091696586459875, -0.0182444937527180, 0.1062938943505287,
       -0.1921905726194382, -0.3598673641681671, -0.3955971598625183, -0.3033332824707031, -0.0801899358630180,
       -0.0075497627258301, -0.0444810241460800, -0.0184596665203571, 0.0334978811442852,  -0.3085982203483582,
       -0.0109336813911796, 0.2610522806644440,  -0.2235621809959412, 0.1303556859493256,  -0.7779822945594788,
       0.0107052447274327,  -0.2403905838727951, 0.2264521867036819,  -0.1785664558410645, 0.0393266752362251,
       -0.2149740904569626, 0.1237290576100349,  -0.3972116410732269, 0.0124925868585706,  -0.6529604196548462,
       -0.1469684988260269, -0.3303533196449280, 0.0507873594760895,  -0.5869878530502319, -0.1206953451037407,
       -0.0668836608529091, -0.0581033416092396, 0.1842327713966370,  0.4386854767799377,  0.2248541712760925,
       -0.3403421044349670, 0.1017744988203049,  -0.0381832495331764, 0.4736146628856659,  -0.2171923518180847,
       0.2682316005229950,  0.3999940454959869,  0.2734471857547760,  -0.3601502478122711, -0.6184719204902649,
       -0.6939406991004944, -0.4342350065708160, -0.4864851832389832, -0.4973088204860687, 0.3383417427539825,
       -0.2832599580287933, -0.4880471527576447, 0.0379270799458027,  0.0193776991218328,  -0.7560240626335144,
       -0.0767447650432587, 0.4481042027473450,  -0.6509139537811279, -0.3677741587162018, -0.2335961163043976,
       -0.5777701139450073, -0.3068402111530304, -0.1068831682205200, 0.2910695075988770,  0.3617959618568420,
       0.8924761414527893,  0.0783315151929855,  -0.2085945606231689, -0.4254047572612762, -0.1611333042383194,
       0.2984495460987091,  -0.3494387567043304, 0.3504840135574341,  0.4611806571483612,  -0.3212269842624664,
       -0.3878781199455261, -1.8913977146148682, -0.4207251667976379, -0.8836871981620789, 0.4130232930183411,
       -1.6060411930084229, 1.3006166219711304,  -1.1884217262268066, -0.3490053117275238, 0.8665181994438171,
       -0.4369785487651825, -0.1041688546538353, -0.1846860200166702, 0.2502507269382477,  -0.4717335402965546,
       -1.4170343875885010, 0.5503864884376526,  -0.5701249837875366, -1.5537497997283936, -0.0234217364341021,
       0.5425876379013062,  0.0725670158863068,  1.7860704660415649,  -0.1361773610115051, -1.0783635377883911,
       -0.1271500885486603, -0.7518488168716431, 1.7972398996353149,  -1.2822031974792480, 0.9634308815002441,
       1.3370729684829712,  -0.2479498237371445, 0.2609046399593353,  -0.2273523658514023, 0.1881332993507385,
       0.0390741899609566,  -0.1425966918468475, -0.0551720038056374, -0.0903135240077972, -0.0550354607403278,
       0.2401293069124222,  -0.6819096207618713, 0.1760581582784653,  0.0949551090598106,  -0.3744879066944122,
       1.0162032842636108,  0.3497434556484222,  -0.1860610544681549, -0.0642595514655113, -0.1115229129791260,
       0.5695039629936218,  -0.0181123167276382, -1.4454501867294312, -0.7363244295120239, 0.9699385762214661,
       0.2848300039768219,  -0.0102330399677157, 0.2708167135715485,  0.0009551418479532,  0.1814893484115601,
       -0.1250056773424149, 0.0962433442473412,  0.1147905662655830,  0.7459686994552612,  -0.2599844634532928,
       0.5111988782882690,  0.2993337810039520,  -0.6019943356513977, 0.2543730139732361,  0.5284679532051086,
       -0.5145500898361206, 0.8507056832313538,  0.7786223888397217,  -0.1811405420303345, 0.9351733922958374,
       -0.6558985710144043, 0.0666636005043983,  0.0321569815278053,  -0.3234342932701111, 0.2185395061969757,
       0.8902684450149536,  -0.5138080120086670, 0.5534310340881348,  -0.1163772642612457, 0.2385928928852081,
       -0.3075707852840424, -0.1506544798612595, 0.0236699711531401,  0.1207064017653465,  0.1983814239501953,
       0.4739328920841217,  -0.5951250195503235, 0.5420888662338257,  -0.2787930071353912, 0.2348463237285614,
       -0.2942997813224792, -0.0944769158959389, -0.2826310098171234, -0.2236874699592590, 0.0810260474681854,
       0.1023346930742264,  -0.2482687383890152, 0.2192770093679428,  0.2090867310762405,  -0.2354756593704224,
       0.0172796566039324,  -0.1500062197446823, 0.6169752478599548,  0.2175778299570084,  0.3757976293563843,
       -0.0080279018729925, 0.0376901477575302,  0.6909323334693909,  0.0556728541851044,  0.0703876838088036,
       -0.0651749670505524, 0.3463284671306610,  0.7435146570205688,  0.4911300241947174,  0.0365158431231976,
       0.0029307787772268,  0.1858734935522079,  -0.0652887821197510, -0.2299838811159134, 0.1645153760910034,
       0.1147408336400986,  0.1312713176012039,  0.0264824908226728,  -0.1835228949785233, -0.0549601167440414,
       0.0126074599102139,  0.1455495208501816,  0.1942554861307144,  -0.0125948693603277, -0.1259017735719681,
       -0.3580411672592163, -0.1231978610157967, -0.0589207522571087, -0.0212842449545860, 0.4485774636268616,
       -0.0685691311955452, -0.4801894724369049, -0.2645901739597321, 0.2938804328441620,  -0.0153330052271485,
       -0.0553619563579559, 0.0159631818532944,  0.1673743724822998,  0.0846926644444466,  -0.6518766880035400,
       0.1069430783390999,  0.1024903655052185,  0.5950145125389099,  -0.5489819645881653, -0.0127502856776118,
       0.1196359395980835,  -0.2363186478614807, -0.6056725382804871, -0.0185322631150484, -0.4349571466445923,
       0.0201622284948826,  0.2953867912292480,  0.4728273749351501,  0.2753897309303284,  0.3689592480659485,
       -0.0631871968507767, 0.2416664361953735,  -0.4776653647422791, -0.0093481941148639, 0.3718614280223846,
       -0.3988884389400482, -0.5656873583793640, -0.0321291945874691, -0.5329883098602295, -0.1469201296567917,
       0.2494527250528336,  -0.2672397792339325, -0.0654673054814339, -0.3238774538040161, 0.0196038149297237,
       -0.1377145498991013, 0.3291330635547638,  -0.2574592530727386, -0.0026329071260989, 0.1043581366539001,
       -0.1749253422021866, -0.1516193300485611, 0.0320897176861763,  -0.2169485241174698, -0.1920994818210602,
       -0.3831999897956848, 0.0428385324776173,  0.2112997025251389,  0.1967796832323074,  0.0854592546820641,
       0.2719625532627106,  -0.1799456775188446, 0.1803328096866608,  -0.0732097774744034, 0.7838404774665833,
       -0.3405862152576447, 0.0425300300121307,  0.1802267879247665,  0.1938145607709885,  0.0652714222669601,
       0.3747397959232330,  0.1909029483795166,  0.7331061959266663,  0.2849372029304504,  -0.2787232697010040,
       -0.0462485253810883, -0.0629559457302094, -0.1615817397832870, 0.1483997255563736,  -0.4448628723621368,
       0.1149489879608154,  0.3709065318107605,  0.4491711258888245,  0.4496735930442810,  -1.1455219984054565,
       0.7236732840538025,  -0.4118214845657349, -0.0282886475324631, 0.2263958752155304,  0.4794995188713074,
       0.1434562504291534,  0.0006004449678585,  0.1850690394639969,  -0.0633230879902840, 0.1419783234596252,
       -0.2017016112804413, 0.1882468163967133,  0.2462685406208038,  0.0330169424414635,  0.3534636199474335,
       -0.4463710784912109, -0.3012762069702148, 0.0414673388004303,  0.0277194138616323,  0.0592425875365734,
       0.5778653025627136,  -0.3225530683994293, 0.0138974031433463,  0.0144064165651798,  -0.2599164545536041,
       -0.1461884826421738, -0.2044612765312195, 0.3068621754646301,  0.0461404658854008,  0.3988641500473022,
       0.1296925544738770,  -0.1823647916316986, 0.0676180049777031,  -0.1739338338375092, -0.0662671253085136,
       -0.5296879410743713, 0.4662995338439941,  -0.2338118255138397, 0.0422840565443039,  0.0407715104520321,
       -0.1106047853827477, 0.1705517619848251,  -0.2045770138502121, -0.4572036564350128, -0.3984205424785614,
       0.2095869630575180,  -0.1014192253351212, -0.2895959019660950, 0.1369364261627197,  -0.1728737950325012,
       0.0503219217061996,  -0.2493536472320557, 0.0835376009345055,  -0.4300962090492249, -0.0079622492194176,
       0.3205482363700867,  0.3588540852069855,  -0.2505346834659576, -0.1776872575283051, 0.0895393267273903,
       -0.3120592236518860, -0.1900280714035034, -0.2184089720249176, 0.4258341193199158,  -0.6066185235977173,
       0.1305289566516876,  -0.5299054384231567, -0.3175418972969055, 0.0890007242560387,  -0.1693279445171356,
       0.1009837314486504,  -1.2259113788604736, -0.0309468004852533, -0.1556403487920761, 0.2265165597200394,
       -0.3251461088657379, -0.3293150663375854, 0.1994870454072952,  -0.4192061424255371, 0.2770861983299255,
       0.0817767232656479,  0.3072889447212219,  -0.1156459525227547, -0.5352562069892883, 0.4688059985637665,
       -0.0499741435050964, -0.3769059181213379, 0.0252589117735624,  0.3681296110153198,  0.5389515161514282,
       -0.2037398517131805, 0.1030240803956985,  -0.6551699638366699, 0.2186369597911835,  -0.2714849710464478,
       0.4762051701545715,  -0.4075942039489746, 0.5502524971961975,  -0.1485016793012619, -0.1655804365873337,
       0.3477124571800232,  0.2595214843750000,  0.2849804461002350,  0.7068743705749512,  -0.3658090233802795,
       0.1630667895078659,  -0.0884508788585663, -0.1605221182107925, -0.3180096745491028, 0.4352405071258545,
       -0.7710721492767334, -0.7969225645065308, -0.4433363974094391, -0.4336347877979279, 0.0205809492617846,
       0.2487639039754868,  0.1455831974744797,  -0.1537930667400360, 0.5242483019828796,  0.2092445790767670,
       -0.7050447463989258, 0.2153209149837494,  -0.3899370431900024, 0.2786776721477509,  -0.0961448475718498,
       -0.4122604727745056, -0.1514431834220886, 0.2019242644309998,  -0.0730224549770355, -0.2829035818576813,
       -0.3535678684711456, 0.3373481929302216,  -0.0913169384002686, -0.2411263436079025, -0.4536783397197723,
       0.1770718991756439,  -0.3095590472221375, -0.1888039559125900, 0.1441944241523743,  -0.0900090038776398,
       -0.0724685788154602, 0.5584933161735535,  0.6859825253486633,  -0.7347702383995056, 0.1119912415742874,
       0.0535226836800575,  -0.3464851379394531, -0.2524056434631348, -0.6992146968841553, -0.2330929934978485,
       -0.6658111214637756, 0.1688435226678848,  0.0719835832715034,  0.4685167372226715,  -0.2211370319128036,
       0.0652129799127579,  -0.1740692257881165, 0.5419487953186035,  0.0585085675120354,  -0.1051787361502647,
       -0.2497164160013199, 0.2203738540410995,  -0.1429469138383865, 0.2072214633226395,  -0.1560582816600800,
       -0.3639286160469055, -0.4026263356208801, 0.5968516469001770,  -0.5448590517044067, -0.3313238322734833,
       0.3514626026153564,  -0.2062505036592484, 0.0647780671715736,  0.1150319352746010,  0.4085392057895660,
       0.1362794935703278,  0.2348950058221817,  0.4596736729145050,  -0.2722897529602051, -0.3386293053627014,
       -0.4148036837577820, 0.0982044339179993,  -0.6891512274742126, -0.2164719849824905, 0.0355757437646389,
       -0.3510904908180237, 0.3099096715450287,  0.2182788550853729,  -0.1144675239920616, -0.2774529755115509,
       -0.0184306818991899, 0.5254337191581726,  -0.4662274718284607, 0.4453413188457489,  0.4435316622257233,
       -0.3087501525878906, -0.3989221453666687, 0.3159257471561432,  0.1910210102796555,  1.0234587192535400,
       0.4310980439186096,  0.3709471523761749,  -0.2944320142269135, 0.8517517447471619,  0.1581891626119614,
       -0.2896938920021057, -0.0033955206163228, -0.3002263009548187, -0.0085675446316600, -0.0490296259522438,
       0.0409536771476269,  0.3682183027267456,  -0.3267387747764587, -0.0594749450683594, 0.5934269428253174,
       -0.0897687077522278, -0.2848825156688690, -0.2859214246273041, -0.2612705528736115, -0.3392143845558167,
       0.2252642214298248,  0.2172107398509979,  0.2627285420894623,  -0.8500605225563049, 0.9182737469673157,
       -0.0908281952142715, -0.1021133959293365, -0.0276834387332201, 0.0812745168805122,  -0.3008817136287689,
       0.2609252333641052,  -0.3750546872615814, -0.1366080939769745, -0.0915011540055275, -0.0400351583957672,
       -0.7038393616676331, 0.4469456076622009,  -0.4320643544197083, 0.4040763080120087,  -0.1664916425943375,
       -0.1771316230297089, -0.4728468358516693, -0.2384097874164581, -0.6498818993568420, -0.5633381605148315,
       0.0388373807072639,  -0.2641542851924896, 0.1221946626901627,  0.1782271862030029,  -0.5374392271041870,
       0.3717792630195618,  0.0013131697196513,  -0.1984708756208420, -0.7810271382331848, -0.2934885621070862,
       0.9171800613403320,  -0.7673806548118591, 0.1962783485651016,  0.1103462055325508,  0.1722513586282730,
       0.2578394412994385,  0.0616388395428658,  0.0280635654926300,  -0.8786223530769348, 0.5569810867309570,
       -0.0871673002839088, 0.4765676558017731,  0.3332014381885529,  -0.1990823745727539, -0.7491599321365356,
       -0.0122638288885355, -0.1769300103187561, -0.3078092932701111, -0.0982435494661331, -0.1971720308065414,
       -0.2316028326749802, -0.3538208603858948, -0.7130392193794250, -0.5479748249053955, -0.2649213671684265,
       -0.1048051938414574, 0.6312254667282104,  -0.2240462303161621, 0.0874660015106201,  0.0028929885011166,
       -0.3586008250713348, -0.0035429897252470, -0.3706852197647095, 0.6786854863166809,  0.6550811529159546,
       0.3620825707912445,  -0.0537033639848232, -0.1428592652082443, -0.1324945837259293, -0.0383647307753563,
       -0.2894392013549805, 0.0937791168689728,  -0.0446016043424606, -0.0007606757571921, 0.0181972719728947,
       -0.2228025048971176, -0.3061878681182861, 0.1256390511989594,  0.0439421124756336,  -0.1959278285503387,
       0.0229294616729021,  0.0246563479304314,  -0.1915880292654037, -0.1607282757759094, -0.0562910400331020,
       0.1398693621158600,  -0.0048548798076808, -0.1583172976970673, -0.0862947851419449, 0.2229516953229904,
       -0.1348004490137100, -0.0001979653752642, 0.0970349162817001,  -0.0964001119136810, 0.1192378550767899,
       -0.0129395620897412, -0.0192015245556831, 0.0716029778122902,  0.3582856953144073,  -0.0393633358180523,
       0.5474153757095337,  -0.5006176233291626, -0.2366453856229782, 0.0101544223725796,  0.2457924932241440,
       0.0250473767518997,  0.4088569581508636,  0.1599816232919693,  -0.2143148779869080, 0.2367502599954605,
       0.2771925330162048,  -0.0296048410236835, 0.4732130467891693,  0.0312293246388435,  -0.2007922679185867,
       -0.0814587250351906, 0.1301628202199936,  -0.0902624502778053, -0.1885021775960922, 0.0304434169083834,
       0.6793798208236694,  -0.6293609142303467, 0.0072503942064941,  -0.2100785374641418, -0.0707664862275124,
       0.1065047085285187,  -0.1505230963230133, 0.4107038974761963,  0.1847167313098907,  -0.1705568879842758,
       -0.4604680538177490, 0.2774312496185303,  -0.4697074890136719, -0.0670226812362671, -0.2124525308609009,
       0.2606459856033325,  -0.3597108423709869, 0.1763888895511627,  -0.3890690803527832, -0.2938679456710815,
       -0.0553331188857555, 0.1198832765221596,  -0.3848665952682495, 0.1132012084126472,  0.3741522133350372,
       0.1292429268360138,  -0.0610792003571987, -0.4853228628635406, -0.2507091164588928, -0.0453479848802090,
       0.2854002118110657,  -0.0951201766729355, -0.0723446831107140, 0.5670679211616516,  0.0548707358539104,
       0.3231678009033203,  -0.0449873358011246, -0.1607340872287750, 0.2397898733615875,  -0.4132620394229889,
       -0.0518993996083736, -0.1930598318576813, 0.0375000648200512,  -0.1979611665010452, 0.1349234133958817,
       -0.2019468545913696, -0.1613635271787643, -0.2670213580131531, 0.1265564411878586,  0.3873687982559204,
       0.3242319822311401,  -0.3372790515422821, 0.3758135139942169,  -0.0150060057640076, -0.3545081019401550,
       0.1692595481872559,  0.2900787591934204,  -0.3102841973304749, 0.1956834346055984,  0.3391278982162476,
       -0.4346110820770264, 0.1004392355680466,  -0.2930947840213776, 0.1673665493726730,  0.6218723654747009,
       -0.3326369225978851, 0.0816263183951378,  0.4079649150371552,  0.2324891537427902,  0.2967743277549744,
       -0.1497221440076828, 0.5471695065498352,  -0.2428293526172638, 0.3898684382438660,  0.3760691881179810,
       0.3878428936004639,  0.0634367614984512,  -0.0076771629974246, 0.0864340066909790,  -0.0764662399888039,
       0.1374252140522003,  -0.2090329229831696, 0.2627854049205780,  0.2769143879413605,  0.1290812343358994,
       0.2229109704494476,  0.3332129120826721,  -0.0971960425376892, -0.2435053437948227, 0.1406134665012360,
       0.1941811293363571,  0.1459430158138275,  -0.4778990745544434, 0.1678360402584076,  0.0453229323029518,
       -0.3404635190963745, -0.5380320549011230, -0.2106297463178635, 0.2261066585779190,  0.3300993740558624,
       0.1512221693992615,  0.1733518987894058,  -0.1259239614009857, 0.2203317731618881,  -0.2739769220352173,
       0.2499892711639404,  0.3553709983825684,  0.0960804075002670,  -0.0219551697373390, -0.3410529792308807,
       -0.2294032573699951, 0.1266218423843384,  -0.0738134458661079, 0.1629081219434738,  0.5682049393653870,
       -0.0917122364044189, -0.3378221392631531, -0.1362816691398621, 0.1436587125062943,  -0.0011543586151674,
       0.2941971719264984,  0.0271310526877642,  -0.1026690900325775, 0.2037898898124695,  -0.0409792698919773,
       -0.0571998618543148, -0.1952870488166809, -0.0142969395965338, 0.4134740829467773,  -0.0579677708446980,
       0.1387702375650406,  -0.0629715621471405, 0.1621268689632416,  0.1366130262613297,  -0.3715382218360901,
       0.6402390003204346,  0.1571527123451233,  0.3135913610458374,  -0.2590428292751312, -0.1054385006427765,
       -0.5615119338035583, 0.1255960166454315,  0.3508070409297943,  0.2416522353887558,  -0.4758975803852081,
       0.2257109284400940,  -1.5443454980850220, 0.3499429523944855,  -0.0515464954078197, -0.1654499173164368,
       -0.9603904485702515, -0.2354310899972916, -0.7105959057807922, -0.4184053242206573, -1.3675905466079712,
       -0.5712086558341980, 0.0951141640543938,  -0.1872690469026566, 0.2203815132379532,  0.1799113750457764,
       -0.2985661625862122, 0.9200212359428406,  0.0228353943675756,  -0.8324683904647827, -0.6100748777389526,
       -0.8264931440353394, 1.9905028343200684,  -1.5019017457962036, 0.6982919573783875,  -0.0446318648755550,
       0.1506022661924362,  0.2915408015251160,  -0.3967178463935852, -0.1243297979235649, 0.0208904221653938,
       -0.3214527070522308, -0.0411034263670444, -0.0506012812256813, -0.1907345801591873, 0.3483209311962128,
       -0.2498249560594559, 0.2712025046348572,  -0.3420903384685516, 0.3043341636657715,  -0.7263747453689575,
       0.0135405715554953,  -0.6636811494827271, 0.3707110583782196,  0.1683494895696640,  0.0348893627524376,
       0.3811911344528198,  0.1892675906419754,  -0.2325890809297562, -0.0854735672473907, 0.1901261955499649,
       -0.2021511644124985, -0.1958831548690796, -0.1627584099769592, 0.6688753962516785,  -0.5006293654441833,
       0.2150356769561768,  0.0903876423835754,  -1.3521592617034912, 0.3749207854270935,  0.2503373324871063,
       -0.4611997008323669, 1.3005611896514893,  0.9826892614364624,  0.1523697823286057,  -0.2158217132091522,
       0.2566960453987122,  1.9341996908187866,  0.1372014135122299,  0.4092971384525299,  0.7713311314582825,
       -0.2446776777505875, 1.0533916950225830,  0.7247181534767151,  0.0026098329108208,  -2.0012683868408203,
       0.6585884094238281,  -0.2315405756235123, -0.0374088138341904, -0.4910282194614410, -0.5029287338256836,
       -0.4903090894222260, -0.1714840531349182, 0.3869284987449646,  1.9755665063858032,  0.1139725595712662,
       -0.1964997947216034, 0.1451052129268646,  -0.0574056133627892, -0.2105819731950760, 0.1810123026371002,
       -0.0107590863481164, -0.2995809316635132, 0.0323341339826584,  -0.2078499048948288, -0.2661844789981842,
       -0.2019646614789963, 0.2093108296394348,  -0.2641140222549438, -0.0077759181149304, 0.2657605409622192,
       -0.0211645197123289, -0.4497485160827637, 0.1440472751855850,  -0.2575873136520386, -0.2115730792284012,
       -0.4667587876319885, -0.0089878598228097, -0.1385737210512161, -0.0037018521688879, 0.0798791870474815,
       0.0716075152158737,  0.1318934261798859,  0.1715379357337952,  0.0694146603345871,  -0.1930291354656219,
       0.0265943799167871,  -0.2642897963523865, 0.5434993505477905,  -0.2936148047447205, 0.2918512523174286,
       0.1502830684185028,  -0.6580904126167297, 0.3009065687656403,  -0.4044268131256104, 0.1515131443738937,
       0.8192436099052429,  -1.4780430793762207, -0.1074559167027473, -0.1950966119766235, -1.8875299692153931,
       0.0881675183773041,  0.2863273322582245,  -0.0324530526995659, -0.1144656836986542, -0.1339019685983658,
       -0.5245387554168701, 0.8012419342994690,  -0.6066524982452393, 0.1745729446411133,  1.2037326097488403,
       0.4151140451431274,  0.4163952767848969,  0.0843628644943237,  -0.1305498927831650, 0.6278534531593323,
       -0.2270988523960114, -0.5083450675010681, -0.4824469983577728, -0.7287737131118774, 2.0056715011596680,
       -2.0148456096649170, 0.1179909780621529,  -0.7800062894821167, 1.4038670063018799,  -0.2589795589447021,
       1.0386322736740112,  -0.1137265488505363, 0.4131010472774506,  -0.0832685977220535, 0.8581538796424866,
       -0.6649534106254578, 1.5488482713699341,  0.9147832989692688,  0.1364445835351944,  0.6193948984146118,
       -1.1382206678390503, 0.2258510142564774,  0.7518653273582458,  -0.2888892292976379, 0.5203962326049805,
       0.1131739392876625,  -1.0039076805114746, 0.3760284483432770,  -0.2412166744470596, -0.0377430655062199,
       -0.0429060198366642, -1.1943465471267700, -0.0169523879885674, 0.3098329603672028,  0.4088913798332214,
       0.7338706254959106,  -1.2664476633071899, 1.2032723426818848,  -0.5441295504570007, 0.2568252384662628,
       -0.3351852893829346, 0.0245494116097689,  -0.6371678709983826, -0.0222093760967255, -0.0006956442375667,
       -0.2697059512138367, -0.2756722569465637, 0.0404995456337929,  -0.1010106131434441, 0.0180511344224215,
       0.1982025653123856,  0.5752106904983521,  0.4931123852729797,  -0.2582256793975830, -0.3309493064880371,
       0.0963974893093109,  0.4897736907005310,  0.3594171702861786,  0.3785725235939026,  0.1011132970452309,
       0.2617187798023224,  -0.1651535928249359, 0.1218903213739395,  0.5706893205642700,  0.0908442139625549,
       0.4834149777889252,  0.3444696962833405,  0.2305905073881149,  -0.1765074729919434, -0.2725587785243988,
       -0.4168943166732788, -0.0185682140290737, 0.0651231780648232,  -0.0013923214282840, -0.4463428556919098,
       0.3076465427875519,  0.0626170188188553,  -0.1076816767454147, -0.0004991803434677, -0.2227298319339752,
       -0.1704904586076736, 0.5295892953872681,  -0.1080516651272774, -0.3714934885501862, -0.1448120623826981,
       0.1120244041085243,  0.1704733371734619,  0.0576939806342125,  0.7125253677368164,  0.5210266113281250,
       -0.0774297565221786, 0.3515717387199402,  0.4027474820613861,  0.0530249811708927,  -0.2917478382587433,
       0.1920521855354309,  -0.0119863618165255, 0.7214813232421875,  -0.0746681615710258, 0.3527530431747437,
       -0.0240100864320993, 0.0105918748304248,  -0.0653173699975014, -0.0609383508563042, 0.2497892826795578,
       -0.5821752548217773, 0.1323988288640976,  0.3591198325157166,  -0.6003471016883850, -0.5965827703475952,
       0.1346353739500046,  -0.5586771368980408, -0.1985718905925751, 0.3551755547523499,  -0.2461072057485580,
       -0.5290685296058655, -0.0448298379778862, 0.0521277077496052,  0.1252287775278091,  -0.3039630353450775,
       -0.2345757037401199, -0.0131447389721870, 0.3509680926799774,  0.0341778770089149,  -0.7324285507202148,
       -0.1443085521459579, -0.8128659725189209, -0.8575302362442017, -0.4689244925975800, -0.3425101041793823,
       0.0134113943204284,  1.0081315040588379,  -0.0418635234236717, 0.4173898696899414,  -0.2373558431863785,
       0.0928501337766647,  0.1299474239349365,  0.3555401265621185,  -0.1005282402038574, 0.9071173071861267,
       -0.7662709951400757, -0.1906433403491974, -0.3179392516613007, -0.3609999418258667, -0.0781114697456360,
       -0.1685242950916290, 0.0463909506797791,  -0.4375888407230377, 0.0968672409653664,  -0.3542028665542603,
       -0.0564926564693451, 0.0185912400484085,  0.4566957652568817,  -0.0595837943255901, -0.0435588397085667,
       0.8586779236793518,  -0.2839729189872742, 0.2280427217483521,  -0.1671904027462006, -1.0031722784042358,
       0.5050103068351746,  -0.2831207513809204, 0.7901977896690369,  -0.0903202444314957, -0.2472353279590607,
       0.3601558208465576,  0.3256774246692657,  0.2917553186416626,  -0.6377460360527039, -0.4208676218986511,
       -0.0772964954376221, 0.8520054817199707,  0.0998637750744820,  -0.6975858807563782, -0.1353944391012192,
       -1.0505734682083130, -0.2007162123918533, -1.3944644927978516, -0.6490579843521118, -0.1735397577285767,
       0.4701121747493744,  0.6002793312072754,  -0.3525463938713074, -0.1319262534379959, 0.3780408203601837,
       0.0271618645638227,  1.2420943975448608,  0.5003924369812012,  -0.4725537896156311, -0.0541564412415028,
       -1.1915882825851440, -1.0650287866592407, -0.0429478771984577, -0.5739668011665344, 0.6521313190460205,
       -0.1900962591171265, -0.0171354953199625, -0.0295300334692001, 1.0070428848266602,  0.3567775785923004,
       -0.1748044490814209, 0.1549630016088486,  -0.6153947710990906, 1.2938011884689331,  -0.9842515587806702,
       0.5673159956932068,  -1.0215489864349365, 0.2900703847408295,  -0.8300272822380066, -0.6618616580963135,
       0.3085863888263702,  -0.7580388188362122, 0.6804464459419250,  -0.0954038947820663, 0.3192566037178040,
       -0.1176174953579903, 1.3784761428833008,  0.0896489620208740,  0.5667291283607483,  -0.0468840003013611,
       -0.5953128337860107, -0.0240370854735374, -0.2219145596027374, 0.4238203763961792,  -0.2826341092586517,
       -0.3256877362728119, 0.9651955366134644,  0.0090183336287737,  -0.1969193965196609, 0.3217235207557678,
       0.4564543664455414,  0.2988548576831818,  0.1531234234571457,  -0.4238215982913971, 0.0655162855982780,
       0.1667526811361313,  -0.4023003280162811, -0.0762673616409302, 0.0176471024751663,  -0.3454259335994720,
       0.2593127489089966,  0.2024131715297699,  -0.1744927465915680, -0.3714730739593506, 0.0031889029778540,
       0.0942615866661072,  0.1116572543978691,  -0.3650786280632019, -0.0923414230346680, 0.0900331437587738,
       0.3347305357456207,  -0.0076248939149082, -0.1707031726837158, -0.0213498827069998, -0.3084737360477448,
       -0.4507806599140167, 0.0706372037529945,  -0.2360941916704178, 0.1070049628615379,  0.4045033454895020,
       -0.0159537047147751, 0.2589667141437531,  -0.2852961421012878, 0.1697868555784225,  0.0989059954881668,
       -0.0369434021413326, -0.0271288361400366, 0.3394306600093842,  -0.3676409721374512, -0.1099186688661575,
       -0.2156916409730911, 0.0185055099427700,  -0.0216215252876282, 0.1095178797841072,  0.0279226675629616,
       -0.0888980850577354, 0.0652649328112602,  -0.1122981309890747, 0.1487668454647064,  -0.2095612138509750,
       0.0117628099396825,  0.0035449007991701,  0.3613574504852295,  0.0296056345105171,  0.0306226406246424,
       0.0375350639224052,  -0.0197327546775341, -0.1523728668689728, -0.1183153167366982, -0.1204496100544930,
       0.2216725051403046,  -0.0030503177549690, -0.0216431505978107, 0.2158644050359726,  -0.1031626537442207,
       0.1863914877176285,  -0.0343162044882774, -0.2117034345865250, -0.0028717713430524, 0.3892485499382019,
       0.0384807996451855,  -0.0984854549169540, 0.0442776829004288,  -0.3818515539169312, 0.3604699671268463,
       -0.1893763393163681, -0.1760332435369492, -0.0320843793451786, 0.1817169636487961,  0.0727073550224304,
       -0.0313953198492527, -0.0590871237218380, 0.2890759110450745,  -0.1009843423962593, 0.1597029864788055,
       0.2964284718036652,  0.1098842918872833,  0.0345022082328796,  -0.2640412449836731, -0.3569051325321198,
       0.2617990076541901,  -0.2368953824043274, 0.2014896273612976,  -0.0968715175986290, -0.0782368704676628,
       0.0011124928714707,  0.2428655773401260,  0.1362093687057495,  0.0617674589157104,  -0.0411842055618763,
       -0.0608500614762306, 0.4488829076290131,  -0.1500301361083984, -0.1796868145465851, -0.2211008071899414,
       -0.0898181647062302, 0.0143747534602880,  0.0032155052758753,  0.0105454204604030,  0.0497980378568172,
       0.2220037728548050,  -0.0613635219633579, 0.1191487088799477,  -0.0995060130953789, 0.2087179571390152,
       -0.0883399620652199, 0.2332773059606552,  0.1272509545087814,  0.3391919732093811,  0.0653014183044434,
       -0.0140664726495743, -0.0363916866481304, 0.0138895995914936,  -0.1721888482570648, 0.3415207564830780,
       -0.3211662471294403, -0.0557341165840626, 0.0931885018944740,  0.2027758210897446,  0.1540737152099609,
       -0.3587419986724854, -0.2599304020404816, -0.0633253529667854, 0.0799993947148323,  -0.2689076066017151,
       0.6108676195144653,  -0.0652224719524384, -0.6701117753982544, 1.2672023773193359,  0.0085154343396425,
       -0.6353114843368530, -0.8497162461280823, 0.2491600066423416,  0.2010373920202255,  -0.1580977141857147,
       -0.0015761939575896, 0.2996614277362823,  0.0702427998185158,  0.1380682438611984,  0.0287616234272718,
       0.9795715212821960,  0.0711718201637268,  -0.2118847817182541, -0.3453052639961243, 1.6998126506805420,
       -0.3064134418964386, 0.0035003209486604,  0.1857955604791641,  -0.3852153718471527, 0.1263217777013779,
       -0.2680145800113678, 0.1818490028381348,  0.0185609292238951,  -0.1561410576105118, 0.0095027768984437,
       -0.1212065890431404, -0.0936219766736031, -0.0083150193095207, 0.0340243130922318,  -0.0398218929767609,
       0.2966136932373047,  0.0710860565304756,  -0.0638255029916763, -0.1725306659936905, 0.0030060887802392,
       -0.0024998257867992, 0.0746654793620110,  -0.0895995274186134, -0.0194147098809481, 0.0163863748311996,
       0.1508589386940002,  -0.1382734626531601, 0.0659097582101822,  -0.0512441247701645, -0.2333436757326126,
       -0.0589293651282787, 0.0133809605613351,  -0.0283659789711237, -0.1166317388415337, 0.2969296276569366,
       0.0001159870589618,  0.0641288980841637,  -0.1991398930549622, 0.0399188362061977,  -0.4843853116035461,
       -0.6731720566749573, 0.0133315203711390,  0.0136138517409563,  0.4408618807792664,  0.6983314156532288,
       0.2476267069578171,  -0.6559127569198608, -0.3626676201820374, -0.6726231575012207, -0.7298272252082825,
       0.2452193945646286,  0.2253931611776352,  0.6725093126296997,  -0.1381423175334930, 0.2408843934535980,
       0.6899650096893311,  -0.0800481289625168, 0.1666660308837891,  0.4845514893531799,  -0.5482645034790039,
       -0.1306118965148926, -0.2686043679714203, -0.9212026000022888, 0.1854267269372940,  -0.0761119052767754,
       -0.3266144990921021, -0.4553465843200684, -0.1228508651256561, -0.1653377115726471, 0.4845042526721954,
       -0.1372304409742355, -0.0751816704869270, -0.1071771830320358, 0.2117235958576202,  -0.5523397326469421,
       0.5889103412628174,  -0.0177859812974930, 0.3344843685626984,  0.1028547659516335,  -0.0775055438280106,
       0.3128348290920258,  -0.6048250198364258, -0.0010071432916448, -0.3187215626239777, 0.1957503259181976,
       0.0313481464982033,  -0.0194596275687218, -0.5656341314315796, 0.0995052307844162,  0.3933426439762115,
       -0.8511690497398376, -0.2932327985763550, -0.3566481173038483, -0.2248636335134506, 0.1298850774765015,
       -0.2909882962703705, 0.4985553622245789,  -0.5139535665512085, 0.0990501195192337,  0.2305043637752533,
       -0.2695368230342865, -0.5305650234222412, -0.3697549700737000, 0.4162798225879669,  0.7522602677345276,
       -0.9016621708869934, -0.5094876885414124, -0.9753677845001221, -0.9505980610847473, -0.4886268377304077,
       0.6792188882827759,  0.8832234144210815,  -0.5691005587577820, 1.2941930294036865,  0.4981701374053955,
       -0.9333149790763855, 0.5909727215766907,  -0.3233360052108765, 0.4871863126754761,  0.5038310289382935,
       -0.1517637073993683, 0.7387756109237671,  -0.1932143867015839, -0.3259587585926056, 0.6132762432098389,
       -0.5632950067520142, 0.8228300213813782,  0.8347887992858887,  0.7151321172714233,  -1.2974396944046021,
       0.6544439196586609,  -0.8162507414817810, 0.8496848344802856,  -0.5180376768112183, -0.1420407146215439,
       -0.4499800503253937, -0.5065262913703918, -0.4038613140583038, -0.5140060782432556, -0.3455515205860138,
       0.0865577310323715,  -0.1189385503530502, 0.1747446507215500,  -0.3888106942176819, -0.3076692521572113,
       -0.0182298049330711, 0.0637089088559151,  0.5058640241622925,  0.2865037322044373,  -0.0818473026156425,
       -0.0442864894866943, 0.6253902316093445,  0.1386273205280304,  0.3040619194507599,  0.3134281635284424,
       0.3818519711494446,  -0.1347831189632416, -0.3086305856704712, -0.2754635512828827, 0.8188865184783936,
       0.3710408210754395,  -0.6830938458442688, -0.3284269571304321, 0.6693716049194336,  -0.5922455191612244,
       0.0052327471785247,  0.0619461350142956,  -0.6176347732543945, -0.4311256706714630, -0.0278869308531284,
       -0.4425881803035736, 0.2276939153671265,  0.0065709669142962,  -0.1705930233001709, -0.0434008873999119,
       0.6093630194664001,  -0.0826809704303741, -0.3692115843296051, 0.0581841506063938};

// NOLINTNEXTLINE(bugprone-easily-swappable-parameters)
expression normalize_min_max(const expression &data, double min_val, double max_val)
{
    return (2_dbl * (data - min_val) / (max_val - min_val)) - 1_dbl;
}

expression rho_approximation(const expression &h, const std::vector<expression> &params)
{
    std::vector<expression> terms;
    terms.reserve(4);

    for (auto i = 0u; i < 4u; ++i) {
        terms.emplace_back(params[i] * exp(-(h - params[i + 8u]) * params[i + 4u]));
    }

    return sum(std::move(terms));
}

} // namespace

// NOTE: geodetic coordinates in the order [h, lat, lon]
// NOTE: doy_expr is the number of days elapsed since the last 1st of january as a function of heyoka::time.
// NOLINTNEXTLINE(bugprone-easily-swappable-parameters)
expression nrlmsise00_tn_impl(const std::vector<expression> &geodetic, const expression &f107, const expression &f107a,
                              const expression &ap,       // NOLINT
                              const expression &doy_expr) // NOLINT

{
    // Sanity checks.
    if (geodetic.size() != 3u) {
        throw std::invalid_argument("The geodetic argument value must have exactly the size 3");
    }

    // The expression for the number of (solar, not sidereal) rotations (rad.) made by the Earth since the last 1st of
    // January 00:00:00 UTC. (seconds in day)
    const expression sid = doy_expr * boost::math::constants::two_pi<double>();
    // The expression for the fraction of the orbit made by the Earth since the last 1st of January 00:00:00 UTC. (day
    // of year)
    const expression doy = doy_expr * (boost::math::constants::two_pi<double>() / 365.25);

    // Preparing the input expressions to the ffnn
    std::vector<expression> in;
    in.push_back(sin(geodetic[2])); // sin(lon)
    in.push_back(cos(geodetic[2])); // cos(lon)
    in.push_back(normalize_min_max(geodetic[1], -boost::math::constants::half_pi<double>(),
                                   boost::math::constants::half_pi<double>())); // geodetic latitude
    in.push_back(sin(sid));
    in.push_back(cos(sid));
    in.push_back(sin(doy));
    in.push_back(cos(doy));
    in.push_back(normalize_min_max(f107, 60.0, 266.0));
    in.push_back(normalize_min_max(f107a, 60.0, 170.0));
    in.push_back(normalize_min_max(ap, 0.0, 110.0));

    // Instantiating the ffnn
    std::vector<expression> delta_params = ffnn(kw::inputs = in, kw::nn_hidden = {32, 32}, kw::n_out = 12,
                                                kw::activations = {tanh, tanh, tanh}, kw::nn_wb = flattened_nw);

    // We extend the gamma parameters as done in training
    delta_params[8] *= 5_dbl;
    delta_params[9] *= 5_dbl;
    delta_params[10] *= 5_dbl;
    delta_params[11] *= 5_dbl;
    // We create an alias as to reflect the semantic change of the values stored by the variable that the for loop will
    // introduce.
    auto &params = delta_params;
    for (decltype(delta_params.size()) i = 0; i < delta_params.size(); ++i) {
        params[i] = (best_global_fit[i] * (1_dbl + delta_params[i]));
    }

    expression retval = rho_approximation(geodetic[0], params);
    return retval;
}

} // namespace model::detail

HEYOKA_END_NAMESPACE
