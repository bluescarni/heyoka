// Copyright 2020, 2021, 2022, 2023, 2024 Francesco Biscani (bluescarni@gmail.com), Dario Izzo (dario.izzo@gmail.com)
//
// This file is part of the heyoka library.
//
// This Source Code Form is subject to the terms of the Mozilla
// Public License v. 2.0. If a copy of the MPL was not distributed
// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

#include "heyoka/kw.hpp"
#include <stdexcept>
#include <vector>

#include <boost/math/constants/constants.hpp>

#include <heyoka/config.hpp>
#include <heyoka/expression.hpp>
#include <heyoka/math/cos.hpp>
#include <heyoka/math/exp.hpp>
#include <heyoka/math/sin.hpp>
#include <heyoka/math/tanh.hpp>
#include <heyoka/model/ffnn.hpp>
#include <heyoka/model/nrlmsise00_tn.hpp>

HEYOKA_BEGIN_NAMESPACE

namespace model::detail
{

const double best_global_fit[12]
    = {4.1363310029108843e-07, 4.0000086372179092e-08, 2.0884869739603035e-13, 2.3135716566189760e-09,
       5.5489346370934431e-02, 3.8843141843337967e-02, 5.4930843422492867e-03, 2.0221186124045831e-02,
       1.6037537639329329e+01, 5.2566535061531994e+01, 8.8684196024896238e+01, 2.6651672474562414e+01};

const double flattened_nw[1804]
    = {0.0127046303823590,  -0.0288678556680679, -0.3411509692668915, 0.0084676370024681,  0.0219716504216194,
       -0.5916647315025330, 0.2112763524055481,  -0.0232623554766178, -0.0412170253694057, -0.1409447044134140,
       0.6809155941009521,  -0.3215263783931732, -0.7837755680084229, 0.7167398929595947,  0.1931682825088501,
       -0.0066013354808092, 0.0355323478579521,  -0.0266979392617941, 0.0201582033187151,  -0.3966859579086304,
       -0.0152542423456907, 0.0006407043547370,  0.5509230494499207,  0.0236600209027529,  -0.0295777507126331,
       -0.0885795131325722, -0.7058025598526001, 0.0312681198120117,  0.0230472087860107,  0.1400951296091080,
       0.4928545653820038,  0.3925542533397675,  -0.3580854237079620, 0.3229091465473175,  0.4572363793849945,
       -0.0034714918583632, -0.0104008587077260, -0.0749187469482422, 0.0575428046286106,  -0.2601438164710999,
       0.0601397901773453,  -0.6510787606239319, 0.5188064575195312,  0.2535654604434967,  0.5272476077079773,
       -0.0358424969017506, 0.1245163232088089,  0.0806126520037651,  -0.0202031228691339, -0.1382807195186615,
       0.1609725803136826,  0.2225456088781357,  -2.9254331588745117, -0.2849982976913452, 0.3001744747161865,
       0.0161626990884542,  0.0364418998360634,  -0.0799265354871750, -0.0575572587549686, 0.2317970097064972,
       0.0297893695533276,  0.0689424797892570,  2.7757062911987305,  0.0664108246564865,  -0.0372392311692238,
       0.0501575842499733,  -0.5369719266891479, -0.0263046268373728, -0.0333429314196110, 0.2347013503313065,
       -0.0637897253036499, 0.0152952857315540,  0.3938122093677521,  0.0123301707208157,  0.0199680030345917,
       0.0154312113299966,  -0.0013310239883140, -0.6218252778053284, -0.0505042485892773, 0.2029934972524643,
       0.3039516210556030,  -0.1196434199810028, -0.8010813593864441, 0.1046017557382584,  -0.2824419438838959,
       -0.0478483512997627, 0.1939447224140167,  0.0011091486085206,  -0.0040030116215348, -0.2363319993019104,
       -0.2416410744190216, 0.1466892659664154,  -1.8389726877212524, 0.2436349242925644,  -0.1091229096055031,
       -0.0375946946442127, 0.3167322874069214,  0.0821243077516556,  -0.0096307899802923, 0.1539136022329330,
       -0.1930830478668213, 0.5086300969123840,  -1.4829707145690918, 0.0230733752250671,  0.2424332797527313,
       0.0112088620662689,  -0.0754479840397835, -0.0015231346478686, 0.0338943600654602,  -0.2564187943935394,
       0.0953109189867973,  0.0662960857152939,  -0.7503352761268616, 0.0579175390303135,  -0.0056180250830948,
       0.0274150427430868,  -0.2095276862382889, -0.3766042888164520, 0.0346002839505672,  0.1810643523931503,
       -0.1417870819568634, 0.5350729823112488,  0.0164586678147316,  0.1781138330698013,  0.0146508691832423,
       0.0136350151151419,  -0.0474651940166950, 0.1772851943969727,  0.0103710070252419,  -0.1823107302188873,
       0.5935531854629517,  0.1208076179027557,  -0.5835396051406860, -0.4320556521415710, 0.4527952969074249,
       -0.0124364281073213, 0.1241416782140732,  0.0352450571954250,  -0.0782494395971298, 0.3376848697662354,
       0.9484586119651794,  -0.0866106599569321, 0.4385417997837067,  0.1187928467988968,  0.8081641197204590,
       -0.0113822873681784, 0.1156260296702385,  0.0888300314545631,  -0.1105621904134750, 0.1049084067344666,
       0.0597754679620266,  -0.0981279760599136, -1.2262015342712402, 0.0279225539416075,  -0.0193642582744360,
       0.0697525143623352,  -0.4549927115440369, 0.0199778601527214,  0.0518762804567814,  -0.2934291362762451,
       0.5273408293724060,  0.1132352501153946,  0.2930108606815338,  0.5338594913482666,  -0.4596320688724518,
       0.0168456044048071,  -0.0656871125102043, -0.0174279604107141, 0.0441481098532677,  -0.0895949900150299,
       0.5341123342514038,  -0.4790603816509247, 0.6294651031494141,  0.6300986409187317,  0.3031286895275116,
       0.0033529119100422,  -0.0164907984435558, -0.0224564131349325, -0.0171034336090088, 0.1366603076457977,
       1.0323368310928345,  0.2859944105148315,  -0.1411518901586533, 1.0680074691772461,  -0.4352804124355316,
       -0.0384650938212872, 0.1768466383218765,  -0.0172716025263071, 0.0125574134290218,  -0.0510338172316551,
       0.3542147874832153,  0.4919906258583069,  0.4265313148498535,  -0.0103555796667933, -0.7173134088516235,
       -0.0064782011322677, -0.0063972952775657, 0.0024654255248606,  -0.0153049118816853, 0.1351785659790039,
       -0.0367713458836079, -0.0024331291206181, -0.0942488834261894, -0.0219178125262260, 0.0235116668045521,
       0.0060741896741092,  -0.0730606094002724, 0.1011587753891945,  -0.3261810541152954, -0.4464961290359497,
       -0.3328771591186523, 0.6094570159912109,  0.1594035327434540,  0.0154565833508968,  -0.8222740292549133,
       -0.0175929274410009, 0.0606710016727448,  -0.0132311778143048, 0.0289251375943422,  -0.3070015907287598,
       -0.5643100738525391, 0.4795879721641541,  0.4040625095367432,  0.2991029918193817,  -0.5715491771697998,
       -0.0217279344797134, 0.0549421869218349,  -0.1005302071571350, 0.0289065428078175,  -0.2764709293842316,
       -0.0570334196090698, -0.4753980338573456, -0.4875718951225281, 0.4449168443679810,  0.0276558268815279,
       0.0253360196948051,  -0.0224520210176706, -0.0013648982858285, -0.0517825148999691, 0.4815885424613953,
       -0.1145701110363007, 0.6439089179039001,  0.9745783209800720,  -0.2848570346832275, -0.4609315097332001,
       0.0046183485537767,  -0.0799503996968269, 0.0184922274202108,  0.0046345093287528,  -0.1224273294210434,
       0.2200181633234024,  -0.6835160255432129, -0.2927855253219604, -0.4309696555137634, -0.3653885722160339,
       -0.0052580311894417, 0.0127295637503266,  0.0641321092844009,  0.0153399957343936,  -0.0317107662558556,
       -0.0353051647543907, 0.0262278784066439,  0.6317207217216492,  -0.0305061787366867, 0.0139597151428461,
       -0.1051841601729393, 0.3921509683132172,  -0.0467363819479942, -0.1003959625959396, -0.0925621166825294,
       0.5950270295143127,  -0.2241078168153763, 0.4718081951141357,  0.3064561188220978,  0.2643268704414368,
       -0.0163385458290577, 0.1033873036503792,  0.2216561138629913,  -0.0791047513484955, 0.4745001792907715,
       -0.3443593978881836, -0.6447096467018127, 0.2002072781324387,  -0.7311487197875977, 0.2105720192193985,
       -0.0032333445269614, -0.0022400827147067, -0.0204639453440905, 0.0131960753351450,  -0.1400147974491119,
       -0.0816434398293495, 0.0187605284154415,  1.4709206819534302,  -0.0315368957817554, 0.0792839527130127,
       0.0921370014548302,  -0.5080738067626953, -0.1087060123682022, 0.0300954412668943,  -0.2564185261726379,
       -0.0636421144008636, 0.0108227105811238,  -0.3045790195465088, -0.0563250109553337, 0.0163652766495943,
       -0.0092856204137206, 0.1040539145469666,  0.2272872179746628,  -0.1135168224573135, 0.8815549612045288,
       -0.0013249759795144, 0.0188234169036150,  0.2714596092700958,  0.0041809771209955,  -0.0258639939129353,
       -0.5248215794563293, 0.1768022924661636,  0.0357542186975479,  0.0366377346217632,  0.1449051648378372,
       -0.0941336527466774, 0.4054545760154724,  -0.1399047970771790, -0.2977766394615173, 0.3320492506027222,
       -0.0891200229525566, -0.0323931872844696, -0.0240331236273050, 0.8630343079566956,  -0.1111135780811310,
       0.0201226938515902,  0.2623043358325958,  -0.2481060177087784, 0.1512293666601181,  0.2648845911026001,
       -0.3630398809909821, 1.0395215749740601,  -0.7289043068885803, 0.5283472537994385,  -0.1287454217672348,
       0.0100303934887052,  -0.6355280280113220, 0.2013589888811111,  0.3158463239669800,  0.5364787578582764,
       -0.5830054879188538, -0.3646971285343170, 0.1378031075000763,  -0.0857821926474571, 0.6360392570495605,
       0.5073614120483398,  0.1861404031515121,  -0.0387640669941902, 0.1278964430093765,  -0.4367745220661163,
       0.1396475583314896,  -0.3227543234825134, -0.2515732645988464, 0.0709529519081116,  -0.3065943717956543,
       0.2006467729806900,  -0.3219238221645355, 0.0819934979081154,  0.0454468876123428,  -0.1066320165991783,
       0.2762162685394287,  -0.1063588336110115, -0.0856142938137054, 0.0496413074433804,  0.1981721222400665,
       -0.0146345784887671, -0.1374099999666214, 0.2021081745624542,  0.4393031001091003,  -0.2327381223440170,
       0.2120369523763657,  -0.0291132386773825, -0.1438411027193069, -0.3328332901000977, -0.0827228128910065,
       0.5261262059211731,  0.3009811937808990,  -0.0767527669668198, 0.2203060835599899,  0.0379191562533379,
       0.0946496129035950,  -0.1419573575258255, -0.2601344883441925, -0.2348571866750717, 0.6003438234329224,
       -0.2672812640666962, -0.1674035489559174, -0.3165840208530426, -0.2158369123935699, 0.2376944571733475,
       -0.3483151793479919, -0.1680279970169067, -0.4867827296257019, -0.0530422702431679, 0.2747241854667664,
       0.2600861787796021,  -0.2047081887722015, 0.0281942058354616,  -0.2454565763473511, -0.0748126283288002,
       -0.1878932714462280, 0.3422617614269257,  0.1851846724748611,  -0.0339581519365311, 0.4477007091045380,
       0.2597344815731049,  -0.0654787346720695, -0.3584078550338745, -0.8369178175926208, -0.3330799043178558,
       -0.0001410124532413, -0.0966574847698212, 0.1538230478763580,  0.0731452107429504,  -0.1982696354389191,
       -0.1636954993009567, 0.0390355922281742,  0.5447529554367065,  -0.2373608350753784, -0.0931834951043129,
       0.1098710820078850,  -0.0518966205418110, -0.1738553792238235, -0.1087704673409462, 0.2231970131397247,
       0.0172991678118706,  0.1554085314273834,  0.3859566152095795,  -0.4617115259170532, -0.0821429863572121,
       -0.4323177039623260, -0.3417879045009613, 0.1200865581631660,  -0.0529695414006710, 0.1602886766195297,
       -0.0241934042423964, -0.2175458371639252, 0.2445073127746582,  0.1197231635451317,  0.0539579652249813,
       -0.4947810769081116, -0.4130892157554626, 0.0060720425099134,  0.1735122650861740,  -0.0201666466891766,
       0.3068945407867432,  -0.0824165195226669, -0.0891035720705986, 0.0890031009912491,  0.1492602229118347,
       -0.3038639128208160, 0.0672802627086639,  -0.1596322357654572, -0.0671622306108475, -0.0261017698794603,
       0.1295669376850128,  -0.1503549814224243, 0.4010013937950134,  0.1017442122101784,  -0.0411571562290192,
       -0.1321607977151871, 0.0262266173958778,  0.0864527896046638,  0.2538736164569855,  0.2041023522615433,
       -0.0099113443866372, 0.1009747609496117,  -0.2014985978603363, -0.1329318732023239, 0.4982714653015137,
       -0.3621959388256073, -0.0353805124759674, -0.2096800506114960, -0.4016945958137512, -0.3978029191493988,
       0.3826244175434113,  0.2176865488290787,  -0.5194048881530762, -0.0314056128263474, -0.5206232666969299,
       0.1432511657476425,  -0.0780027881264687, -0.6148346662521362, 0.2442702054977417,  0.0477004200220108,
       0.4278146326541901,  0.2344924509525299,  -0.4424325227737427, -0.2316371500492096, 0.3212744891643524,
       0.3922776579856873,  -0.3092373907566071, 0.0956228598952293,  0.2908343076705933,  -0.1381550431251526,
       0.2212083488702774,  0.0576494187116623,  0.1443331539630890,  0.0880818367004395,  -0.1157887950539589,
       0.1342289447784424,  0.1983468830585480,  -0.4720309674739838, 0.1232310384511948,  -0.0547717139124870,
       -0.5403590202331543, -0.2133001536130905, 0.0050119794905186,  0.0290061365813017,  -0.1140993461012840,
       0.5799598097801208,  -0.2600347399711609, -0.0683505460619926, -0.3594098985195160, 0.1079541966319084,
       0.2650997042655945,  -0.0874044373631477, 0.1296872049570084,  -0.3408768177032471, -0.1783463060855865,
       -0.1758657842874527, 0.0299881529062986,  -0.0414585210382938, 0.0436220690608025,  -0.0317908078432083,
       -0.0396330282092094, 0.0453038103878498,  0.0333376266062260,  -0.0565094836056232, -0.3428216576576233,
       -0.4310514330863953, -0.1376253962516785, 0.3992502391338348,  -0.5015327334403992, 0.0725572556257248,
       0.3663044869899750,  -0.6831942200660706, -0.0319261364638805, 0.0435870327055454,  -0.3062536716461182,
       -0.0263283122330904, 0.4624625444412231,  0.0691615939140320,  0.2779107987880707,  -0.0609040446579456,
       -0.1324630975723267, 0.2691403329372406,  -0.1294673085212708, -0.2606320977210999, 0.2065416723489761,
       -0.2966072559356689, 0.0876547247171402,  -0.0566969923675060, 0.0038816318847239,  0.4819662868976593,
       0.0859193205833435,  0.0958099439740181,  -0.0240215156227350, -0.0234198682010174, -0.2898868918418884,
       0.0839060544967651,  0.2378263473510742,  0.1337088197469711,  -0.0336407199501991, 0.2326708883047104,
       0.2227070480585098,  -0.0073092849925160, -0.2074699997901917, -0.1152145564556122, 1.4379516839981079,
       0.1649250686168671,  0.0540578179061413,  0.3702360689640045,  -0.0538219921290874, -0.1007447466254234,
       -0.2042217105627060, -0.0309019312262535, -0.0053858547471464, -0.0680786073207855, 0.2862070500850677,
       0.0773908495903015,  0.0106235304847360,  -0.0029500003438443, -0.1954375803470612, 0.0292170643806458,
       -0.3431407511234283, -0.0889843031764030, 0.1836090683937073,  -0.1915078312158585, -0.2794493734836578,
       -0.5462505817413330, 0.1990501582622528,  -0.5469913482666016, -0.1542101651430130, -0.2695968449115753,
       0.0095345526933670,  0.0160199850797653,  0.0858277380466461,  -0.3894945085048676, -0.2422488778829575,
       -0.0780493170022964, 0.0753726139664650,  -0.0447698198258877, 0.0238891057670116,  0.3497369587421417,
       0.2167129069566727,  -0.1298321038484573, -0.1111281067132950, 0.7940121889114380,  -0.5672584176063538,
       -0.2992295324802399, -0.2845345735549927, 0.4021616578102112,  -1.1840997934341431, 0.8325365185737610,
       0.0472210757434368,  0.2551282942295074,  -0.0801019817590714, -0.4191633462905884, 0.0568239577114582,
       0.0835566967725754,  -0.0315808244049549, -0.0100887771695852, 0.4572888612747192,  0.1897211670875549,
       0.1000596806406975,  0.3811350166797638,  0.2572140395641327,  0.0232227146625519,  -0.1536481380462646,
       -0.0497052334249020, 0.2550072073936462,  -0.0837275981903076, 0.2500766515731812,  0.0005897367955185,
       0.0081828255206347,  -0.3150599598884583, -0.0734843090176582, 0.0065733413212001,  -0.8180191516876221,
       -0.1101950630545616, -0.0124651789665222, 0.1425426900386810,  0.3488717973232269,  -0.0664146095514297,
       -0.2399914115667343, -0.0212945155799389, 0.3684613704681396,  0.1102916970849037,  0.1937318593263626,
       0.1326223909854889,  -0.0548681467771530, -0.3391688168048859, 0.8193929195404053,  0.3004091382026672,
       -0.2629709541797638, 0.5693883299827576,  -0.4068805575370789, 0.4158484041690826,  -0.1913157850503922,
       -0.2218315005302429, -0.0441019833087921, -0.1938581764698029, -0.1595806777477264, 0.1596823632717133,
       -0.0891662314534187, 0.0949042513966560,  0.1149947792291641,  -0.3121075034141541, -0.1155158802866936,
       1.2382028102874756,  -0.1082831993699074, 0.3963520526885986,  0.1194582059979439,  -0.3387081921100616,
       0.1499182432889938,  -0.8920635581016541, -0.0597250089049339, -0.2197958528995514, -0.3626788258552551,
       -0.3371479511260986, -0.1797751039266586, -0.3454530835151672, -0.4295493364334106, 0.3656016588211060,
       0.2684075236320496,  0.1519811004400253,  0.1567862033843994,  -0.0357160940766335, -0.5447831153869629,
       0.4005700349807739,  -0.2786625325679779, 0.2386009842157364,  0.2315721064805984,  -0.1282668560743332,
       0.3004634082317352,  -0.1999770253896713, -0.1709298938512802, -0.0615624375641346, 0.2954294085502625,
       -0.1745042800903320, -0.2435080260038376, -0.0136613342911005, 0.0930970609188080,  -0.1073380708694458,
       0.3793691098690033,  0.2194841504096985,  -0.4098803699016571, 0.3122341632843018,  0.4081522524356842,
       -0.8912080526351929, -0.1196514740586281, -0.0300597958266735, -0.1963973790407181, 0.5766836404800415,
       -0.0274294987320900, 0.1750637888908386,  0.0529321469366550,  0.2981255054473877,  -0.7615774869918823,
       -0.2696915864944458, -0.0118030887097120, -0.1682601124048233, 0.2188834249973297,  -0.1189440935850143,
       0.6508411765098572,  0.3319309055805206,  0.0344066545367241,  -0.7032781243324280, -0.7023898959159851,
       -0.3657073676586151, -0.4177567958831787, -0.3893449008464813, -0.2203216552734375, 0.0973028391599655,
       -0.0320059433579445, -0.4180611670017242, -0.4620967507362366, 0.0428086854517460,  -0.3174864947795868,
       -0.1375565677881241, -0.1134150996804237, 0.0947506129741669,  0.1814973652362823,  -0.0719608142971992,
       -0.0274160113185644, -0.2684521377086639, -0.2452923208475113, 0.1441132426261902,  0.1081693321466446,
       0.2587628662586212,  -0.3278672397136688, 0.0294059291481972,  0.0753053948283195,  -0.0544149279594421,
       -0.2136988192796707, 0.1306948810815811,  0.0253292210400105,  0.4867273867130280,  -0.0167566947638988,
       0.2321762591600418,  0.1398047357797623,  0.4150123000144958,  -0.2764875590801239, 0.5384034514427185,
       0.2809957861900330,  0.0464618355035782,  0.3504326343536377,  0.1945997774600983,  1.2866588830947876,
       -0.2238956242799759, 0.3345057368278503,  1.0604736804962158,  -0.3865940272808075, 0.1731039732694626,
       -0.2136630564928055, 0.9947341084480286,  -0.2117557823657990, 0.1967599838972092,  0.9972013831138611,
       -1.2488121986389160, -0.1921457797288895, -0.5955083966255188, -0.2108549624681473, 1.0239315032958984,
       -0.2877945601940155, 0.6041355729103088,  0.2956459224224091,  -1.2131876945495605, 0.4488280117511749,
       0.5347111821174622,  1.3935898542404175,  -0.2036786675453186, -0.4070223867893219, 0.0462851189076900,
       -0.0795942097902298, -0.0147520164027810, 0.8048955202102661,  -0.1040998846292496, -0.3875845074653625,
       -0.1261073201894760, 0.1045456528663635,  -0.3883069455623627, 0.4515015184879303,  0.1231594830751419,
       0.1562293022871017,  0.2506539523601532,  -0.1367629319429398, 0.1828761100769043,  -0.1345481723546982,
       -0.2958635389804840, -0.0749991387128830, 0.0581449717283249,  -0.0264827497303486, -0.3317379653453827,
       -0.5268868803977966, -0.1548118889331818, 0.0091783013194799,  -0.0617493242025375, -0.1727915853261948,
       -0.0344823151826859, 0.9617654681205750,  0.0298175979405642,  -0.3117259144783020, -0.4145651757717133,
       0.6140935420989990,  -0.2908197343349457, -0.0754190906882286, -0.4121609330177307, -0.0279771983623505,
       -0.0555296391248703, 0.4563266634941101,  -0.2754036486148834, 0.2196840494871140,  -0.0388627909123898,
       -0.2214705646038055, -0.2944913804531097, 0.1247823610901833,  -0.0661866068840027, -0.0211355909705162,
       -0.1549215018749237, 0.1896495074033737,  0.0918791219592094,  -0.3132714331150055, 0.4254553318023682,
       0.0874408632516861,  0.0946627780795097,  -0.1727046817541122, -0.0723083838820457, 0.0564203709363937,
       -0.0772250741720200, -0.5099260807037354, -0.1090182736515999, -0.0499179996550083, -0.1020826026797295,
       0.1058941036462784,  -0.1002909466624260, 0.1067988499999046,  0.0703317895531654,  0.0115890819579363,
       0.5069950222969055,  0.2184454351663589,  -0.2406777143478394, 0.0634132698178291,  -0.1169770732522011,
       0.1234864741563797,  0.1247568428516388,  -0.0476490408182144, 0.0512553267180920,  -0.1133428663015366,
       -0.0251630973070860, -0.3347419500350952, 0.2801539003849030,  0.3602567613124847,  -0.0465078167617321,
       0.4667392671108246,  -0.6436350941658020, 0.0030276232864708,  -0.5857216119766235, 0.0261120516806841,
       0.2233492881059647,  0.2053976804018021,  0.0867733135819435,  0.1637738943099976,  -0.3522641658782959,
       0.6570618748664856,  -0.3534078896045685, -0.0114608015865088, 0.0455852635204792,  -0.0459851883351803,
       -0.1873010098934174, -0.2606438100337982, -0.4027007818222046, 0.3057228326797485,  0.3009482622146606,
       -0.1377279758453369, -0.1573788523674011, 0.5571709871292114,  0.0308317001909018,  -0.3063233494758606,
       -0.5224317908287048, 0.1882833838462830,  -0.1540520787239075, 0.1445799171924591,  -0.6379568576812744,
       -0.0559002794325352, 0.1304186582565308,  -0.7946385145187378, 0.8259896039962769,  0.1191792637109756,
       0.4112009406089783,  0.1039019450545311,  -0.3392276465892792, 0.0205565113574266,  -0.4592377543449402,
       -0.4938681721687317, 0.7358745336532593,  0.4997407495975494,  -0.2823952436447144, -0.4431041181087494,
       0.2693800628185272,  -0.2007035166025162, 0.1406860351562500,  0.0568743720650673,  -0.0693045929074287,
       0.2052396982908249,  0.0828057527542114,  0.0086868293583393,  -0.2176707237958908, -0.0293484944850206,
       0.0879824683070183,  0.3608603775501251,  -0.0139633771032095, 0.3391073048114777,  0.1418472528457642,
       -0.2901481986045837, 0.1046652793884277,  -0.0978368893265724, 0.1413758844137192,  -0.0024303970858455,
       0.2790777087211609,  0.2159390747547150,  -0.1047052070498466, 0.0798201411962509,  0.0351094976067543,
       0.1854428201913834,  -0.2186463177204132, 0.1206239014863968,  0.1922254115343094,  -0.1089270189404488,
       0.2348700165748596,  0.2388946861028671,  -0.1112112626433372, -0.0356907024979591, -0.1806906312704086,
       0.0335454083979130,  -0.2130877673625946, -0.1747039109468460, -0.2906240224838257, 0.4016160666942596,
       0.1400957256555557,  0.1599002778530121,  0.0059592621400952,  0.0038469112478197,  -0.0114535531029105,
       0.2810331881046295,  0.1158192828297615,  0.0603267364203930,  -0.1325695961713791, -0.1600134968757629,
       0.0886214971542358,  -0.3633708953857422, 0.9259385466575623,  -0.2158323824405670, -0.0560496263206005,
       0.0185306146740913,  -0.1668233275413513, -0.1089965701103210, -0.6812033653259277, -0.5444009304046631,
       -0.0792387351393700, 0.1402813792228699,  -0.4435334205627441, 0.2803072333335876,  0.2240495830774307,
       0.2289288938045502,  -0.0350408256053925, -0.0335509628057480, 0.2194723784923553,  0.0567237809300423,
       0.3202024996280670,  -0.2731653153896332, -0.3103986680507660, -0.3324204981327057, -0.0326223038136959,
       -0.0076235611923039, 0.2339138835668564,  -0.2123388051986694, 0.4345105588436127,  0.5016105175018311,
       0.1862152069807053,  -0.2627129256725311, 0.2389264255762100,  -0.3917145133018494, 0.1350762993097305,
       0.1539918482303619,  -0.0122166927903891, -0.0688040405511856, 0.3150580227375031,  0.0501046441495419,
       0.1958411633968353,  -0.1681318581104279, -0.2319298088550568, 0.0225628912448883,  0.0459110811352730,
       0.7311372160911560,  -0.0883708447217941, 0.3887309730052948,  0.0243974924087524,  0.1451133638620377,
       0.2328097671270370,  -0.4002453684806824, 0.1644749492406845,  0.3352162539958954,  0.0502277649939060,
       0.0953898653388023,  -0.1366885304450989, 0.0347778350114822,  0.1905673444271088,  -0.2313355952501297,
       -0.2548551559448242, 0.0685930401086807,  0.1293068081140518,  0.1439851075410843,  -0.0249637570232153,
       0.2111603319644928,  -0.2348106652498245, -0.1035944893956184, -0.2307463586330414, 0.5801325440406799,
       0.1957745552062988,  0.1850488930940628,  0.0160274822264910,  0.2595900595188141,  -0.0426936447620392,
       -0.4083450436592102, -0.3632008433341980, 0.1352346837520599,  -0.1456638723611832, -1.0538244247436523,
       -0.0115122133865952, -0.1365414708852768, 0.1848233193159103,  0.3286365866661072,  0.1534700244665146,
       0.2829440236091614,  -0.1419819742441177, 0.0956259518861771,  0.2679725587368011,  -0.5359727740287781,
       -0.0240597799420357, -0.2480941861867905, -0.4535450637340546, -0.1956455260515213, 0.0970376655459404,
       0.1208883002400398,  -0.1738094240427017, 0.7349841594696045,  -0.3956096768379211, 0.0528415478765965,
       -0.2750014364719391, 0.1031943261623383,  0.1914923638105392,  -0.2376538217067719, 0.2434460073709488,
       0.5608118176460266,  -0.2140736728906631, 0.0524365268647671,  -0.0964968502521515, 0.2539416849613190,
       0.3553720712661743,  -0.0591440536081791, 0.1064967066049576,  0.0591469667851925,  0.0936221629381180,
       0.0135319819673896,  -0.0868556499481201, -1.0481746196746826, 0.1310021877288818,  -0.1044100895524025,
       -0.1908902972936630, 0.1585061848163605,  -0.0378198921680450, 0.0763715431094170,  0.1109440326690674,
       0.2190035581588745,  -0.0978449806571007, 0.0354211814701557,  0.1438662409782410,  0.2040342539548874,
       0.2948475182056427,  -0.0359405390918255, 0.4955116510391235,  -0.0143779460340738, -0.0991191342473030,
       -0.0671858862042427, 0.4367819130420685,  -0.5970662832260132, 0.4315271079540253,  0.0833565816283226,
       0.3940709829330444,  -0.5570186972618103, -0.1433347165584564, -0.4144471883773804, -0.0510682761669159,
       -0.2120478302240372, 0.2226455807685852,  0.0540897212922573,  0.4063017666339874,  0.1000737771391869,
       -0.3039762675762177, -0.4174763858318329, 0.1517004817724228,  -0.0833822116255760, -0.0386847928166389,
       -0.3901081979274750, 0.1323448419570923,  0.1254846006631851,  0.2960897684097290,  0.1980597227811813,
       0.3010064959526062,  0.1597722917795181,  -0.5835075378417969, 0.0457639656960964,  -0.0188284441828728,
       0.4556331038475037,  0.4304624795913696,  -0.0382641218602657, 0.5365294814109802,  0.0320621840655804,
       -0.0315924808382988, 0.4741728007793427,  -0.1738674789667130, 0.3536525070667267,  0.1287371963262558,
       -0.0127686178311706, 0.2145764976739883,  0.1186229661107063,  0.0829502195119858,  0.4885690510272980,
       0.3839949965476990,  0.2679673731327057,  0.1041027531027794,  0.4033664464950562,  0.2788811624050140,
       0.2973343133926392,  0.0764205083250999,  -0.1256394386291504, 0.3191862702369690,  0.1919944137334824,
       0.0957041084766388,  -0.0626298561692238, 0.2517794668674469,  0.0469234809279442,  -0.3141507208347321,
       -0.0671651735901833, -0.0485396571457386, 0.2949184179306030,  0.4173223972320557,  -0.0271938871592283,
       0.2516073882579803,  0.0908775404095650,  -0.0187109112739563, 0.7288323640823364,  0.1726399511098862,
       0.4407754540443420,  -0.1180802956223488, 0.1095374897122383,  -0.4041772782802582, 0.4177105128765106,
       0.1281701624393463,  -0.0743751674890518, -0.1131716519594193, -0.0556398816406727, -0.1271907240152359,
       -0.1896316558122635, 1.1222045421600342,  -0.0570287108421326, 0.3061273097991943,  -0.0779104605317116,
       0.8345065116882324,  -0.2480766624212265, 0.1455968320369720,  0.0326774120330811,  -0.0032507006544620,
       -0.1319369077682495, 0.1616836339235306,  0.0022187740541995,  0.1993859857320786,  1.6373132467269897,
       0.0767156332731247,  0.0665732175111771,  -0.0822733715176582, 0.0313442535698414,  -0.0850728750228882,
       0.4974969923496246,  0.0121481595560908,  0.0613595657050610,  0.2098080366849899,  -0.1226242631673813,
       -0.4108007550239563, -0.1174032613635063, -0.1181701570749283, -0.2797709703445435, 0.0705255866050720,
       0.1108247116208076,  -0.0069851181469858, 0.1238301917910576,  -0.4620326161384583, 0.1124130189418793,
       -0.0210697501897812, 0.1418794244527817,  0.0480309575796127,  0.0415139831602573,  -0.2015822976827621,
       -0.0526710674166679, 0.0156170325353742,  -0.2458730190992355, 0.2852402031421661,  0.0929677709937096,
       0.0489576049149036,  -0.4112406075000763, -0.0441459417343140, 0.0734218582510948,  -0.3510322868824005,
       -0.1399186700582504, 0.0944854542613029,  -0.4457467496395111, -0.0629009678959846, 0.0790762826800346,
       0.2169000506401062,  -0.0281395893543959, 0.2351789921522141,  0.2303907871246338,  0.1994670629501343,
       -0.4514051079750061, -0.4189090132713318, -0.1912157237529755, 0.3342272937297821,  0.4429363608360291,
       -0.2081588059663773, 0.4181098341941833,  0.3525050580501556,  0.1169933900237083,  0.3615743815898895,
       -0.4686853885650635, 0.1898046582937241,  0.1931944042444229,  0.0371662937104702,  -0.0391498170793056,
       -0.0424432121217251, 0.0282934196293354,  -0.1399873197078705, -0.2679431736469269, 0.1653423160314560,
       0.0592584758996964,  0.0638774484395981,  -0.1333386301994324, -0.2836323380470276, 0.1409528106451035,
       -0.0962278470396996, -0.1560216695070267, -0.0147177297621965, 0.3954609334468842,  -0.0804736465215683,
       -0.2740374505519867, -0.1822728216648102, 0.1609519273042679,  -0.2404961138963699, -0.2175901830196381,
       0.2689409852027893,  0.0609979629516602,  -0.0452555418014526, -0.6023078560829163, 0.0055695078335702,
       0.4762569367885590,  -0.1014756858348846, -0.0062980121001601, -0.0496911928057671, 0.8812808990478516,
       0.1606209576129913,  0.3984073400497437,  -0.0555343255400658, 0.3258831202983856,  -0.3353210091590881,
       -0.2474191933870316, 0.0625950023531914,  0.8972213268280029,  0.0548208467662334,  0.1852399855852127,
       -0.5448415279388428, 0.3709781765937805,  0.4356129765510559,  -0.0292186401784420, 0.1274883747100830,
       -0.1974186897277832, 0.2085862308740616,  -0.2973355650901794, 0.0415324606001377,  0.4700458943843842,
       0.0006704439292662,  -0.0117271579802036, 0.2741914391517639,  0.0377263687551022,  0.2475697994232178,
       0.2930195927619934,  0.2386776357889175,  0.0747398883104324,  -0.3533694744110107, 0.0255311336368322,
       0.1750259250402451,  0.0548778325319290,  0.3724328279495239,  0.2929729223251343,  -0.1163561046123505,
       -0.1275943517684937, 0.1230961978435516,  -0.2052607238292694, -0.0589973554015160, -0.0750420838594437,
       0.1731760799884796,  0.5798555612564087,  -0.1327219456434250, 0.2129817306995392,  0.0506319254636765,
       0.1560574620962143,  0.2551831305027008,  0.4015626609325409,  0.2234251052141190,  0.0499845407903194,
       -0.2043505758047104, -0.1738124340772629, -0.2604156434535980, 0.0215189866721630,  0.0920898467302322,
       -0.1474594771862030, -0.0694315731525421, 0.0163785945624113,  0.0757270306348801,  0.2233894914388657,
       -0.0426223129034042, 0.1109797582030296,  -0.0483165793120861, 0.1097435727715492,  -0.0572213940322399,
       -0.1983298063278198, -0.1355784982442856, 0.0400941669940948,  0.2266950309276581,  0.5039079189300537,
       -0.1097364127635956, 0.0842725411057472,  0.0392596758902073,  -0.0017214929684997, 0.1110927239060402,
       0.3935337066650391,  1.0364445447921753,  -0.5894287824630737, 0.0706663727760315,  0.0169334858655930,
       -0.0703233554959297, -0.1418846249580383, -0.1305447816848755, -0.1961006075143814, -0.2188457697629929,
       -0.6235550642013550, -0.1494413018226624, -0.0599439255893230, -0.4235903620719910, -0.3267039060592651,
       0.5031483769416809,  0.4111914336681366,  -0.1464141607284546, 0.4622917771339417,  -0.3972215652465820,
       -0.4609479606151581, -0.4241328239440918, -0.0840883478522301, 0.6885706782341003,  -0.0985329076647758,
       0.2738505005836487,  0.4906809628009796,  -0.2194385379552841, -0.1203391999006271, -0.1473597437143326,
       0.0210954025387764,  -0.0931508317589760, -0.1297565251588821, 0.6472645401954651,  0.0934584587812424,
       0.0517167523503304,  0.0366202592849731,  -0.3207484781742096, 0.0912658572196960,  0.3689919710159302,
       -0.2235055863857269, -0.0239851158112288, -1.2243546247482300, 0.6157181262969971,  -0.1111753061413765,
       -0.3060742914676666, 0.3377966284751892,  -0.0908314809203148, -0.0368691235780716, -0.3083716630935669,
       -0.6951585412025452, 0.9255486726760864,  -0.0504614487290382, -1.0303800106048584, 0.0579815991222858,
       -0.1982141733169556, 0.0241615287959576,  -0.5610756278038025, -0.1819557696580887, -0.4549023509025574,
       0.3270750343799591,  -0.3058131933212280, -0.0102889873087406, -0.1690009385347366, -0.2938943505287170,
       0.1673065125942230,  0.0450971089303493,  0.7120008468627930,  0.2485617995262146,  0.1478307545185089,
       -0.2097591757774353, -0.1015786230564117, -0.2869472205638885, 0.0950385183095932,  -0.5196295380592346,
       0.0264936182647943,  -0.1754712015390396, -0.5056455731391907, -0.2897476255893707, 0.3946594595909119,
       0.1201832592487335,  -0.1459461450576782, 0.5976942181587219,  -0.1737747490406036, -0.4386042356491089,
       -0.8384154438972473, 0.0280163642019033,  0.2894909381866455,  0.0333952344954014,  0.1972296684980392,
       0.1603269726037979,  0.0072489241138101,  -0.1360963732004166, -0.1767612546682358, 0.0467998944222927,
       0.1432092487812042,  -0.5118622183799744, 0.7144796252250671,  0.0430194400250912,  0.3910505771636963,
       0.0749170035123825,  -0.1367960274219513, 0.0298439152538776,  0.0396656543016434,  0.0252741314470768,
       -0.2142017185688019, 0.0108351381495595,  0.0260262824594975,  0.0252483058720827,  -0.0669461116194725,
       0.0067325630225241,  0.0063677877187729,  0.0496999062597752,  -0.0567798539996147, 0.0009371095220558,
       -0.0175980124622583, 0.0055102608166635,  -0.0276018436998129, 0.0378828607499599,  0.0492533296346664,
       0.0255509559065104,  -0.0047672796063125, 0.0739652439951897,  -0.0826684832572937, -0.0090984562411904,
       -0.0970697477459908, 0.0114486943930387,  -0.1524998098611832, 0.1928457468748093,  0.0670507997274399,
       -0.2079601138830185, -0.0513880699872971, 0.0144585380330682,  -0.0729600191116333, -0.0474411845207214,
       -0.0627308413386345, -0.0443521887063980, -0.2373042404651642, -0.0296503212302923, -0.0913979560136795,
       -0.0232578050345182, -0.1037768945097923, -0.0680433362722397, 0.1380905956029892,  0.0887688696384430,
       -0.0214787665754557, 0.1129554137587547,  -0.1410957276821136, -0.0242091435939074, -0.0925776883959770,
       -0.0535952150821686, 0.2015610486268997,  0.0234875176101923,  0.1590021550655365,  0.1260455697774887,
       -0.0547875389456749, -0.0711928904056549, -0.0887672379612923, -0.0022691341582686, -0.0133836884051561,
       -0.1652270853519440, 0.1337619423866272,  -0.1568947583436966, -0.0328080020844936, 0.0190565511584282,
       -0.1403603702783585, -0.0118248350918293, -0.0927404761314392, -0.1037841886281967, -0.0414161421358585,
       -0.2052846848964691, 0.0692042633891106,  -0.0671067163348198, -0.1986233890056610, 0.0884123668074608,
       0.0958283320069313,  0.0227828416973352,  -0.0721116587519646, -0.0700438320636749, 0.1121560260653496,
       -0.0458493717014790, -0.2209547460079193, -0.0859665870666504, 0.0153419421985745,  -0.0669480711221695,
       0.0799366459250450,  0.0371797718107700,  -0.0954637750983238, -0.0087806228548288, 0.0437054485082626,
       -0.0561762750148773, 0.0171210188418627,  0.0832030847668648,  0.0858205258846283,  -0.1220736354589462,
       0.1272720098495483,  0.0741007626056671,  -0.0706417486071587, -0.0557997189462185, -0.0736194476485252,
       -0.2017939090728760, -0.1244067028164864, -0.0320542454719543, 0.0632567852735519,  -0.1467971503734589,
       -0.2352289110422134, 0.1613929420709610,  0.1673582196235657,  -0.0582631118595600, -0.0880213081836700,
       0.1300048083066940,  -0.0582306757569313, -0.0569050796329975, -0.2070051729679108, -0.1507062762975693,
       -0.0821387097239494, -0.0820888429880142, 0.1897341161966324,  -0.0727212876081467, -0.1455694735050201,
       -0.1332225054502487, 0.1611399054527283,  -0.1112963035702705, 0.1039719581604004,  0.0026133018545806,
       0.2441376447677612,  -0.1851047426462173, 0.2030969411134720,  0.1098159551620483,  -0.2070569545030594,
       0.3273924589157104,  0.4695096313953400,  0.5686978101730347,  -0.7694518566131592, -0.2301751822233200,
       0.1631902456283569,  0.3929875493049622,  -0.3565367460250854, -0.1343069970607758, 0.1722520291805267,
       0.3510488569736481,  -0.6000965833663940, 0.3827944397926331,  -0.2383302152156830, -0.3035239279270172,
       -0.0462623834609985, 0.7776755094528198,  0.5472193956375122,  -0.0028574552852660, -0.5781450867652893,
       0.4166384041309357,  -0.9485397934913635, -0.3655706346035004, -0.9402677416801453, 0.1978177577257156,
       -0.7552567720413208, 0.1985861361026764,  0.4482573270797729,  0.0848918482661247,  -0.5918813347816467,
       0.1205655038356781,  -0.1189619675278664, 0.1351785212755203,  0.2329567521810532,  0.8475210666656494,
       -0.2892898917198181, -0.1458742767572403, -0.7783219814300537, 0.9119259119033813,  0.3148578703403473,
       -1.2150716781616211, -0.6404905915260315, 0.3765233159065247,  -0.2323489487171173, 0.2918962240219116,
       -0.7844170331954956, 0.1056445240974426,  0.3475126922130585,  0.8827053308486938,  0.5480912923812866,
       1.5121284723281860,  -0.3347523212432861, 0.4475330114364624,  0.1563215106725693,  -0.1036873683333397,
       -2.0163199901580811, 0.2469980418682098,  -0.1211509332060814, 0.4013439118862152,  -0.0454384237527847,
       -0.1206278428435326, -0.3830219507217407, -0.1094331070780754, -0.2260726243257523, 0.3979443311691284,
       0.8120138645172119,  -0.6626051664352417, -0.2400704175233841, -1.8116556406021118, 0.8117458224296570,
       -0.5320154428482056, -1.5660539865493774, 0.8310149312019348,  0.2081204801797867,  -0.5089432001113892,
       -1.0583339929580688, -1.2594389915466309, 1.5612277984619141,  -0.5066528916358948, -0.3326411247253418,
       0.2987559437751770,  -2.1507227420806885, -0.1516938656568527, -1.0075620412826538, -0.6881213784217834,
       -1.4998568296432495, 1.1555302143096924,  -0.0595399215817451, -0.5214861631393433, 0.8547664880752563,
       0.5919337868690491,  -1.0473783016204834, -0.1239156424999237, 1.4879757165908813,  0.6289089322090149,
       0.0261288471519947,  0.8821172118186951,  0.6634972095489502,  -0.1150700300931931, -1.4354957342147827,
       -1.5373972654342651, 0.3683553636074066,  0.9716489911079407,  3.3822631835937500,  -1.4146106243133545,
       -0.9877701997756958, 1.1270447969436646,  -0.2035579085350037, -1.0527923107147217, 0.8959039449691772,
       0.5383793711662292,  0.4832791686058044,  0.3546924889087677,  0.8865063786506653,  0.8679746389389038,
       -2.2148940563201904, 2.2013301849365234,  0.5960624814033508,  -1.9018269777297974, -1.4396243095397949,
       0.8750182986259460,  0.0067980163730681,  1.0499693155288696,  -0.7300521731376648, -1.0444065332412720,
       -0.1143977120518684, -0.8843753933906555, 2.1023173332214355,  0.7202386260032654,  0.2594832777976990,
       -0.6658374071121216, 0.2253111600875854,  0.1392963826656342,  -0.0579804405570030, -0.8136573433876038,
       -0.6709369421005249, -0.5167159438133240, -0.6649653315544128, 0.4769462943077087,  -0.4062770307064056,
       0.2141486853361130,  -0.5433826446533203, -0.3254596590995789, 0.8881859779357910,  0.5771002769470215,
       -0.6065309643745422, -0.2753469049930573, -0.4349989295005798, -0.7400459051132202, 0.3742139637470245,
       -0.6132460832595825, 0.1032870858907700,  0.6320815682411194,  0.8830942511558533,  0.2690224647521973,
       0.5308575630187988,  0.7807701230049133,  0.3983589112758636,  0.8912610411643982,  -0.6793007254600525,
       -0.1148101687431335, 0.1931791901588440,  0.1319238543510437,  -0.0259343609213829, -0.1868679523468018,
       0.2892175018787384,  0.0534032061696053,  0.3552894592285156,  0.2693235576152802,  -0.2302283197641373,
       -0.0138905849307775, -0.3514573872089386, 0.3831593990325928,  -0.0875211656093597, 0.2475802600383759,
       -0.0722635760903358, -0.1824999153614044, -0.0616413801908493, -0.3140061795711517, -0.1346145719289780,
       0.3134225904941559,  -0.0570016205310822, 0.0103696556761861,  -0.0037006556522101, -0.1186446547508240,
       0.0057423091493547,  0.3875475823879242,  -0.3581832647323608, 0.0802682638168335,  0.3436518609523773,
       0.0175252519547939,  0.2423980832099915,  0.4938308000564575,  -0.2058091312646866, -0.1993375867605209,
       -0.3694669604301453, -0.1149451062083244, 0.0006226829718798,  -0.0925481542944908, 0.1125161424279213,
       1.0641143321990967,  -0.9799813032150269, -0.3911733329296112, 0.8118111491203308};

// NOLINTNEXTLINE(bugprone-easily-swappable-parameters)
expression normalize_min_max(const expression &data, double min_val, double max_val)
{
    return (2_dbl * (data - min_val) / (max_val - min_val)) - 1_dbl;
}

expression rho_approximation(const expression &h, const std::vector<expression> &params)
{
    expression retval = 0_dbl;
    for (auto i = 0u; i < 4ul; ++i) {
        retval += params[i] * exp(-(h - params[i + 8]) * params[i + 4]);
    }
    return retval;
}

// NOLINTNEXTLINE(bugprone-easily-swappable-parameters)
expression nrlmsise00_tn_impl(const std::vector<expression> &geodetic, const expression &f107a, const expression &f107,
                              const expression &ap,       // NOLINT
                              const expression &doy_expr) // NOLINT

{
    // Sanity checks.
    if (geodetic.size() != 3u) {
        throw std::invalid_argument("The geodetic argument value must have exactly the size 3");
    }

    // The expression for the number of (solar, not sidereal) rotations (rad.) made by the Earth since the last 1st of
    // January 00:00:00 UTC. (seconds in day)
    const expression sid = doy_expr * boost::math::constants::two_pi<double>();
    // The expression for the fraction of the orbit made by the Earth since the last 1st of January 00:00:00 UTC. (day
    // of year)
    const expression doy = doy_expr / 365.25 * boost::math::constants::two_pi<double>();

    // Preparing the input expressions to the ffnn
    std::vector<expression> in;
    in.push_back(sin(geodetic[2])); // sin(lon)
    in.push_back(cos(geodetic[2])); // cos(lon)
    in.push_back(normalize_min_max(geodetic[1], -boost::math::constants::half_pi<double>(),
                                   boost::math::constants::half_pi<double>())); // geodetic latitude
    in.push_back(sin(sid));
    in.push_back(cos(sid));
    in.push_back(sin(doy));
    in.push_back(cos(doy));
    in.push_back(normalize_min_max(f107, 60.0, 266.0));
    in.push_back(normalize_min_max(f107a, 60.0, 170.0));
    in.push_back(normalize_min_max(ap, 0.0, 110.0));

    // Instantiating the ffnn
    std::vector<expression> delta_params = ffnn(kw::inputs = in, kw::nn_hidden = {32, 32}, kw::n_out = 12,
                                                kw::activations = {tanh, tanh, tanh}, kw::nn_wb = flattened_nw);

    // We extend the gamma parameters as done in training
    delta_params[8] *= 5_dbl;
    delta_params[9] *= 5_dbl;
    delta_params[10] *= 5_dbl;
    delta_params[11] *= 5_dbl;
    // We create an alias as to reflect the semantic change of the values stored by the variable that the for loop will
    // introduce.
    auto &params = delta_params;
    for (decltype(delta_params.size()) i = 0u; i < delta_params.size(); ++i) {
        params[i] = (best_global_fit[i] * (1_dbl + delta_params[i]));
    }

    expression retval = rho_approximation(geodetic[0], params);
    return retval;
}

} // namespace model::detail

HEYOKA_END_NAMESPACE
