
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Compiled functions &#8212; heyoka 6.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=32485e33"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tut_cfunc';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="api_reference.html" />
    <link rel="prev" title="Parallel mode" href="tut_parallel_mode.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/white_logo.png" class="logo__image only-light" alt="heyoka 6.0.0 documentation - Home"/>
    <script>document.write(`<img src="_static/white_logo.png" class="logo__image only-dark" alt="heyoka 6.0.0 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="basic_tutorials.html">Basic tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="tut_taylor_method.html">Taylorâ€™s method</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_expression_system.html">The expression system</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_adaptive.html">The adaptive integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_adaptive_custom.html">Customising the adaptive integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_param.html">Runtime parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_nonauto.html">Non-autonomous systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_d_output.html">Dense &amp; continuous output</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_events.html">Event detection</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="advanced_tutorials.html">Advanced tutorials</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tut_batch_mode.html">Batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_extended_precision.html">Computations in extended precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_arbitrary_precision.html">Computations in arbitrary precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_single_precision.html">Computations in single precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_s11n.html">Serialisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_ensemble.html">Ensemble propagations</a></li>
<li class="toctree-l2"><a class="reference internal" href="tut_parallel_mode.html">Parallel mode</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Compiled functions</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api_reference.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="definitions.html">Macros and definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="namespaces.html">Namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="kwargs.html">Keyword arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="mdspan.html">Multidimensional array views</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="expression_system.html">Expression system</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="variable.html">Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="number.html">Numerical constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="param.html">Runtime parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="func.html">N-ary functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="expression.html">Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="math.html">Mathematical functions</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="cfunc.html">Compiled functions</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="ad_notes.html">Notes on automatic differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="breaking_changes.html">Breaking changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="known_issues.html">Known issues</a></li>


<li class="toctree-l1"><a class="reference internal" href="acknowledgement.html">Acknowledgement</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/bluescarni/heyoka" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bluescarni/heyoka/issues/new?title=Issue%20on%20page%20%2Ftut_cfunc.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/tut_cfunc.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Compiled functions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-example">A simple example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-evaluation">Batch evaluation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="compiled-functions">
<span id="tut-cfunc"></span><h1>Compiled functions<a class="headerlink" href="#compiled-functions" title="Link to this heading">#</a></h1>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.0.</span></p>
</div>
<p>heyoka can compile just-in-time (JIT) multivariate vector functions defined
via the <a class="reference internal" href="tut_expression_system.html#tut-expression-system"><span class="std std-ref">expression system</span></a>. This feature
is described and explored in detail in a
<a class="reference external" href="https://bluescarni.github.io/heyoka.py/notebooks/compiled_functions.html#cfunc-tut" title="(in heyoka.py)"><span class="xref std std-ref">dedicated tutorial</span></a> for heyoka.py, the
Python bindings of heyoka.</p>
<p>In Python, just-in-time compilation can lead to substantial
speedups for function evaluation. In C++, the performance argument
is less strong as C++ does not suffer from the same performance
pitfalls of Python: if you need fast evaluation of a function,
you can just implement it directly in C++ code without resorting
to just-in-time compilation.</p>
<p>Nevertheless, even in C++ heyokaâ€™s compiled functions offer
a few advantages over plain C++ functions:</p>
<ul class="simple">
<li><p>because functions are compiled just-in-time, they
can take advantage of all the features of the
host CPU. Most importantly, heyokaâ€™s compiled functions
support <a class="reference internal" href="#tut-cfunc-batch"><span class="std std-ref">batch evaluation</span></a>
via <a class="reference external" href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD instructions</a>
which can provide a multifold speed boost over
plain (scalar) C++ functions;</p></li>
<li><p>batch mode evaluation of compiled functions also supports
multithreaded parallelisation, which can provide another substantial
performance boost on modern multicore machines;</p></li>
<li><p>heyokaâ€™s functions support automatic differentiation up to
arbitrary order, thus it is possible to evaluate the derivatives
of a compiled function without any additional effort;</p></li>
<li><p>heyokaâ€™s functions can be defined at runtime, whereas C++
functions need to be defined and available at compilation time.
This means that it is possible to create a compiled
function at runtime from user-supplied data (e.g., a configuration
file) and evaluate it with optimal performance.</p></li>
</ul>
<p>The main downside of compiled functions is that the
compilation process is computationally expensive and thus
just-in-time compilation is most useful when a function needs to
be evaluated repeatedly with different input values (so that the
initial compilation overhead can be absorbed by the evaluation
performance increase).</p>
<section id="a-simple-example">
<h2>A simple example<a class="headerlink" href="#a-simple-example" title="Link to this heading">#</a></h2>
<p>As an initial example, we will JIT compile the simple bivariate
function</p>
<div class="math notranslate nohighlight">
\[f\left(x, y \right) = x^2 - y^2.\]</div>
<p>We begin with the definition of the symbolic
variables and of the symbolic function to be compiled:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Init the symbolic variables.</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_vars</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create the symbolic function.</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">sym_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
</pre></div>
</div>
<p>Next, we create a compiled function via the
<a class="reference internal" href="cfunc.html#_CPPv4I0EN6heyoka5cfuncE" title="heyoka::cfunc"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">cfunc</span></code></a> class:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Create the compiled function.</span>
<span class="w">    </span><span class="n">cfunc</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cf</span><span class="p">{{</span><span class="n">sym_func</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">}};</span>
</pre></div>
</div>
<p>Note how <code class="docutils literal notranslate"><span class="pre">sym_func</span></code> was passed to the constructor of
<a class="reference internal" href="cfunc.html#_CPPv4I0EN6heyoka5cfuncE" title="heyoka::cfunc"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">cfunc</span></code></a> enclosed in curly brackets:
this is because in general <a class="reference internal" href="cfunc.html#_CPPv4I0EN6heyoka5cfuncE" title="heyoka::cfunc"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">cfunc</span></code></a> expects
in input a vector function - that is, a list of expressions
representing the function components.
In this specific case, we are compiling a vector function with
only one component.</p>
<p>Like many other heyoka classes, <a class="reference internal" href="cfunc.html#_CPPv4I0EN6heyoka5cfuncE" title="heyoka::cfunc"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">cfunc</span></code></a> is
a class template parametrised over a single type <code class="docutils literal notranslate"><span class="pre">T</span></code> representing
the floating-point type to be used for function evaluation. In this
case, we are operating in standard <code class="docutils literal notranslate"><span class="pre">double</span></code> precision.</p>
<p>Let us inspect the compiled function object by printing
it to screen:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Print the compiled function object to screen.</span>
<span class="w">    </span><span class="n">fmt</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cf</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C++ datatype: double</span>
<span class="go">Variables: [x, y]</span>
<span class="go">Output #0: (x**2.0000000000000000 - y**2.0000000000000000)</span>
</pre></div>
</div>
<p>We can now proceed to evaluate the compiled function. In order to do
so, we need to store the input values in a memory buffer and prepare
a memory buffer to store the result of the evaluation. We can use for
both <code class="docutils literal notranslate"><span class="pre">std::array</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Prepare the input-output buffers.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out</span><span class="p">{};</span>
</pre></div>
</div>
<p>We stored the values <span class="math notranslate nohighlight">\(1\)</span> and <span class="math notranslate nohighlight">\(2\)</span> in the input buffer, which
means that the function will be evaluated for <span class="math notranslate nohighlight">\(x=1\)</span> and <span class="math notranslate nohighlight">\(y=2\)</span>.</p>
<p>We can now proceed to invoke the call operator
of <a class="reference internal" href="cfunc.html#_CPPv4I0EN6heyoka5cfuncE" title="heyoka::cfunc"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">cfunc</span></code></a>, which will write the result of the
evaluation into <code class="docutils literal notranslate"><span class="pre">out</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Invoke the compiled function.</span>
<span class="w">    </span><span class="n">cf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">);</span>
</pre></div>
</div>
<p>Let us print <code class="docutils literal notranslate"><span class="pre">out</span></code> to screen in order to confirm that the evaluation
was successful:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Print the output.</span>
<span class="w">    </span><span class="n">fmt</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Output: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Output: [-3]</span>
</pre></div>
</div>
</section>
<section id="batch-evaluation">
<span id="tut-cfunc-batch"></span><h2>Batch evaluation<a class="headerlink" href="#batch-evaluation" title="Link to this heading">#</a></h2>
<p>The simple example we have just seen consisted of the evaluation of a function
over a single value for each variable. <a class="reference internal" href="cfunc.html#_CPPv4I0EN6heyoka5cfuncE" title="heyoka::cfunc"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">cfunc</span></code></a> also supports
evaluation of a function over batches of input values for each variable.</p>
<p>In order to perform batch evaluation, we first have to define new
memory buffers to store the inputs and outputs of the evaluation.
We select a batch size of <span class="math notranslate nohighlight">\(2\)</span>, which means we need storage for
<span class="math notranslate nohighlight">\(2 \times 2 = 4\)</span> input values and <span class="math notranslate nohighlight">\(2\)</span> output values:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Prepare input-output buffers for batch evaluation.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in_batch</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1.1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2.2</span><span class="p">};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_batch</span><span class="p">{};</span>
</pre></div>
</div>
<p>In batch evaluations, input values for a single batch are expected to be stored
contiguously. That is, the input buffer will be interpreted as a row-major
bidimensional array in which each row contains the batch of input values for
a single variable. In this specific example, we will be evaluating the function
for <span class="math notranslate nohighlight">\(x=\left[ 1, 1.1 \right]\)</span> and <span class="math notranslate nohighlight">\(y=\left[ 2, 2.2 \right]\)</span>.</p>
<p>In the next step, we create bidimensional views over the input/output buffers
with the help of <a class="reference internal" href="mdspan.html#_CPPv4I0000EN6heyoka6mdspanE" title="heyoka::mdspan"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">mdspan</span></code></a> and the convenience typedefs
<a class="reference internal" href="cfunc.html#_CPPv4N6heyoka5cfunc5in_2dE" title="heyoka::cfunc::in_2d"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">cfunc::in_2d</span></code></a> and <a class="reference internal" href="cfunc.html#_CPPv4N6heyoka5cfunc6out_2dE" title="heyoka::cfunc::out_2d"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">cfunc::out_2d</span></code></a>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Prepare the views onto the input-output buffers.</span>
<span class="w">    </span><span class="n">cfunc</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">in_2d</span><span class="w"> </span><span class="n">in_view</span><span class="p">{</span><span class="n">in_batch</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>
<span class="w">    </span><span class="n">cfunc</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">out_2d</span><span class="w"> </span><span class="n">out_view</span><span class="p">{</span><span class="n">out_batch</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>
</pre></div>
</div>
<p>As we just explained, the input data is interpreted as a <span class="math notranslate nohighlight">\(2 \times 2\)</span> array while
the input data is interpreted as a <span class="math notranslate nohighlight">\(1 \times 2\)</span> array.</p>
<p>We are now ready to perform a batch evaluation:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Invoke the compiled function.</span>
<span class="w">    </span><span class="n">cf</span><span class="p">(</span><span class="n">out_view</span><span class="p">,</span><span class="w"> </span><span class="n">in_view</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, we can print to screen the result of the evaluation:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Print the output.</span>
<span class="w">    </span><span class="n">fmt</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Output: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">out_batch</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Output: [-3, -3.6300000000000003]</span>
</pre></div>
</div>
<p>For this simple example, we used a batch size of <span class="math notranslate nohighlight">\(2\)</span>, but arbitrarily
large batch sizes are possible. If the batch size is large enough, heyoka
will parallelise the computation using multiple threads of execution, leading
to substantial speedups on multicore machines.</p>
<p>While in this tutorial we operated in standard <code class="docutils literal notranslate"><span class="pre">double</span></code> precision for simplicity,
compiled functions can also operate in single, extended, quadruple and multiple precision.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tut_parallel_mode.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Parallel mode</p>
      </div>
    </a>
    <a class="right-next"
       href="api_reference.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API Reference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-example">A simple example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-evaluation">Batch evaluation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Francesco Biscani, Dario Izzo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2020, 2021, 2022, 2023, 2024 Francesco Biscani, Dario Izzo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>