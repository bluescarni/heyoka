version: '{build}'

branches:
  except:
    - /pr\/.+/

environment:
  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
      BUILD_TYPE: MSVC2019

install:
- call "C:\\Miniconda37-x64\\Scripts\\activate.bat"
- conda config --set always_yes yes
- conda update -n base conda
- conda config --add channels conda-forge
- conda config --set channel_priority strict
- conda create --name heyoka cmake llvmdev tbb-devel tbb boost-cpp xtensor xtensor-blas blas blas-devel 'fmt=8.1.*' 'spdlog=1.10.*' sleef zlib libzlib
- call activate heyoka

build_script:
- set CONDA_PREFIX_PATH=C:\Miniconda37-x64\envs\heyoka\Library
- mkdir build
- cd build

# heyoka
- cmake .. -G "Visual Studio 16 2019" -A x64 -DCMAKE_PREFIX_PATH=%CONDA_PREFIX_PATH% -DCMAKE_INSTALL_PREFIX=%CONDA_PREFIX_PATH% -DHEYOKA_BUILD_TESTS=ON -DHEYOKA_BUILD_TUTORIALS=ON -DBoost_NO_BOOST_CMAKE=ON -DHEYOKA_ENABLE_IPO=yes -DHEYOKA_WITH_SLEEF=yes
- cmake --build . --config Release --target install


test_script:
- ctest -j4 -V -C Release

# Enable this to be able to login to the build worker. You can use the
# `remmina` program in Ubuntu, use the login information that the line below
# prints into the log.
# on_finish:
# - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
